<!doctype html><html lang=en-ca dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Speeding up pip's Windows CI by setting TEMP to the D: drive | Richard Si</title>
<meta name=keywords content="pip"><meta name=description content="By simply moving all temporary file I/O onto the D: drive, pip's Windows CI times decreased by up to 30% on GitHub Actions."><meta name=author content><link rel=canonical href=https://ichard26.github.io/blog/2025/03/faster-pip-ci-on-windows-d-drive/><link crossorigin=anonymous href=/assets/css/stylesheet.0bd812de4c712334307c155dff81892f2ba44c911203cd8f1c88c0856a1b5410.css integrity="sha256-C9gS3kxxIzQwfBVd/4GJLyukTJESA82PHIjAhWobVBA=" rel="preload stylesheet" as=style><link rel=icon href=https://ichard26.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ichard26.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ichard26.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ichard26.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ichard26.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en-ca href=https://ichard26.github.io/blog/2025/03/faster-pip-ci-on-windows-d-drive/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=ichard26.github.io src=https://webstats.internal.floralily.dev/js/script.outbound-links.js></script><meta name=google-site-verification content="4PNzC3Db8jI_wn9D8lPdAh4B0skrLZHNbQBgVF1XtAo"><meta property="og:url" content="https://ichard26.github.io/blog/2025/03/faster-pip-ci-on-windows-d-drive/"><meta property="og:site_name" content="Richard Si"><meta property="og:title" content="Speeding up pip's Windows CI by setting TEMP to the D: drive"><meta property="og:description" content="By simply moving all temporary file I/O onto the D: drive, pip's Windows CI times decreased by up to 30% on GitHub Actions."><meta property="og:locale" content="en-ca"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-03-10T00:00:00-04:00"><meta property="article:tag" content="Pip"><meta name=twitter:card content="summary"><meta name=twitter:title content="Speeding up pip's Windows CI by setting TEMP to the D: drive"><meta name=twitter:description content="By simply moving all temporary file I/O onto the D: drive, pip's Windows CI times decreased by up to 30% on GitHub Actions."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://ichard26.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Speeding up pip's Windows CI by setting TEMP to the D: drive","item":"https://ichard26.github.io/blog/2025/03/faster-pip-ci-on-windows-d-drive/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Speeding up pip's Windows CI by setting TEMP to the D: drive","name":"Speeding up pip\u0027s Windows CI by setting TEMP to the D: drive","description":"By simply moving all temporary file I/O onto the D: drive, pip's Windows CI times decreased by up to 30% on GitHub Actions.","keywords":["pip"],"articleBody":" TL;DR If your GHA Windows jobs are I/O heavy, double check whether the I/O work is happening on the C: drive (OS) or D: drive (working space). If the C: drive is being used, you will likely benefit by moving that work to the D: drive. If you‚Äôre feeling more adventurous, you should also consider trying a ReFS/Dev Drive.\nA few weeks ago, I was waiting for pip‚Äôs CI to turn üçè so I could merge a PR. I‚Äôd just spent an hour on review and had pushed a few final tweaks. Waiting an additional 20 minutes was the last thing I wanted to do.1\nI was sufficiently annoyed with checking and re-checking the CI status, so I enabled auto-merging on the repository so I could at least focus my attention on something entirely different while waiting for CI to pass. That smoothed over the pain, but it got me wondering, can pip‚Äôs tests (and CI in particular) be faster?\nIt turns out for the Windows CI jobs, the answer was: yes, they could be much faster.\nHow slow was pip‚Äôs Windows CI? At the time of writing2, pip‚Äôs Github Actions CI workflow consists of 28 jobs. 23 run the test suite across Ubuntu, macOS, Windows, and CPython 3.8 through 3.13.\n7 on the ubuntu-latest runners 6 on the macos-latest (ARM) runners 6 on the macos-13 (Intel) runners 4 on the windows-latest runners The extra Ubuntu job runs the functional test suite against a zipapp version of pip.\nOn the other hand, the Windows jobs have historically been so slow that we don‚Äôt even test pip across the entire supported Python version matrix. We only test the oldest and newest version, 3.8 and 3.13, on Windows. Plus, the test suite is sharded over two jobs per version because‚Äîas you can probably guess‚Äîthe Windows jobs are that much slower üêå.\nI wrote a script that queries the GitHub API and calculates the average job duration over the last X successful runs. As a baseline, this is what pip‚Äôs CI looked like:\nLast 50 CI runs on main Job Mean Minimum Stdev ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tests / 3.10 / macos-latest 6:25 5:44 0:34 (8%) tests / 3.11 / macos-latest 6:40 6:03 0:39 (9%) tests / 3.9 / macos-latest 6:57 6:03 0:55 (13%) tests / 3.13 / macos-latest 6:59 6:15 0:37 (8%) tests / 3.12 / macos-latest 7:09 6:14 1:01 (14%) tests / 3.8 / macos-latest 7:11 6:32 0:31 (7%) tests / 3.11 / ubuntu-latest 9:33 9:08 0:10 (1%) tests / 3.10 / ubuntu-latest 10:04 9:43 0:14 (2%) tests / 3.12 / ubuntu-latest 10:34 10:16 0:14 (2%) tests / 3.13 / ubuntu-latest 10:35 10:10 0:12 (2%) tests / 3.13 / Windows / 2 10:39 9:55 0:20 (3%) tests / 3.8 / ubuntu-latest 11:02 10:41 0:14 (2%) tests / 3.13 / Windows / 1 11:13 10:29 0:24 (3%) tests / 3.9 / ubuntu-latest 11:44 11:20 0:19 (2%) tests / 3.10 / macos-13 12:10 8:53 2:16 (18%) tests / 3.11 / macos-13 12:59 9:09 2:34 (19%) tests / 3.13 / macos-13 12:59 9:54 2:41 (20%) tests / 3.9 / macos-13 13:10 10:09 2:42 (20%) tests / 3.8 / macos-13 13:34 10:09 2:30 (18%) tests / 3.12 / macos-13 13:55 9:54 3:23 (24%) tests / 3.8 / Windows / 2 14:58 14:04 0:26 (2%) tests / zipapp 16:53 16:27 0:15 (1%) tests / 3.8 / Windows / 1 17:37 16:40 0:30 (2%) Among the slowest three jobs, the Windows 3.8 jobs hold the 3rd and 1st places for duration. Yikes!\nWindows file I/O is poor on GitHub Actions It‚Äôs a known issue that file I/O on the Windows runners is noticeably slower than the Ubuntu and macOS runners.\nAs a package installer, pip‚Äôs test suite is especially I/O heavy. Most functional tests require at least setting a scratch environment and installing something into it. Countless files and directories are created, opened, and deleted during a run.\nMoving TEMP to the D: drive According to Steve Dower, the GHA Windows workers have a slow (but read-optimized) C: system drive and a faster D: drive for working space.\nWarning Only the standard Windows runners have a D: drive. The larger (paid) Window runners do NOT have a D: drive. For such situations, ReFS/Dev Drives should be considered.\nFor many projects, this is probably fine. The repository is still checked out on the D: drive. Any files you create in the checkout will be on the D: drive. For pip‚Äôs test suite, however, all of the temporary files are created under the system temporary directory. Where is this path set to by default? On the C: drive at C:/Users/runneradmin/AppData/Local/Temp/.3\nThus, pip‚Äôs CI was being slowed down by reading and writing primarily to the non-performant disk.\nThe good news is that this can be overridden by setting the TEMP environment variable which Python‚Äôs tempfile will respect.\n- name: Set TEMP to D:/Temp run: | mkdir \"D:\\\\Temp\" echo \"TEMP=D:\\\\Temp\" \u003e\u003e $env:GITHUB_ENV This simple switch to D:/Temp translated into the Windows CI time decreasing by up to 30%. üéâ\nJob Before After % decrease Python 3.8 (1) 17m 37s 12m 41s 28% Python 3.8 (2) 14m 58s 10m 44s 28% Python 3.13 (1) 11m 13s 9m 53s 11% Python 3.13 (2) 10m 39s 9m 32s 10% Or in graph form (note: the data shown here is slightly more recent than the statistics).\nWhat about ReFS or Dev Drives? When I was investigating ways to improve file I/O performance on Windows, I‚Äôd discovered Dev Drives. Now, I am no Windows expert. I stopped using the OS on a daily basis many years ago, but the TL;DR is they are a new kind of storage volume, built on the modern ReFS (Resilient File System) filesystem and designed with developer workloads in mind.\nThe uv project has had good success with using ReFS to speed up their Windows GHA jobs, thus I actually started with a ReFS drive4 while optimising pip‚Äôs Windows CI. Unfortunately, using a ReFS drive was noticeably slower than simply moving TEMP to the D: drive. ReFS did save ~a minute for Python 3.8 (1) but that pales in comparison with the nearly five minutes improvement from TEMP=D:/Temp.\nThe performance improvements of ReFS/Dev Drives are primarily realized by deferring malware scans (Dev Drive only) and the inherent optimizations of the newer ReFS filesystem. Presumably the malware scans are already disabled on GitHub Actions, which would explain why pip‚Äôs CI did not see as big of an improvement as I was expecting.\nGiven uv‚Äôs success with ReFS, I can‚Äôt universally recommend using the D: drive over ReFS/Dev Drives, and vice versa. Which one will be faster is likely workload dependent. If you would like to experiment with ReFS/Dev Drives, my Powershell script to create such a drive can be found here. To invoke it, simply pass the desired drive letter and volume size: devdrive.ps1 -Drive R -Size 4GB.\nHappy experimenting!\nBefore you kill me for complaining, let me provide some context‚Ä¶ When I used to maintain Black, I never really noticed how CI took. Most of the jobs would finish in 3-6 minutes. Short enough that I could look over my changes one last time, add notes as comments, and then come back to merge. I did notice that Black‚Äôs test suite was slow, taking a good few minutes on the slow laptop I had at that time. I took a look at the test logic, trimmed redundant work, and added pytest-xdist for parallelized testing. Afterwards, local test suite runs took less a minute!\nI was spoiled by Black‚Äôs fast tests and CI, admittedly.¬†‚Ü©Ô∏é\nI wrote the majority of this post in January‚Ä¶¬†‚Ü©Ô∏é\nWe‚Äôve actually set it to C:/Temp to work around filename too long errors. Also, the exact default system temporary directory may vary from worker to worker. I don‚Äôt feel like double checking this.¬†‚Ü©Ô∏é\nWhen I did my experiments, the Windows GHA runners did not support Dev Drives. Only ReFS was supported.¬†‚Ü©Ô∏é\n","wordCount":"1319","inLanguage":"en-ca","datePublished":"2025-03-10T00:00:00-04:00","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://ichard26.github.io/blog/2025/03/faster-pip-ci-on-windows-d-drive/"},"publisher":{"@type":"Person","name":"Richard Si","logo":{"@type":"ImageObject","url":"https://ichard26.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ichard26.github.io/ accesskey=h title="Richard Si (Alt + H)">Richard Si</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ichard26.github.io/about/ title=About><span>about</span></a></li><li><a href=https://ichard26.github.io/blog/ title=Writing><span>writing</span></a></li><li><a href=https://ichard26.github.io/privacy/ title="Privacy Statement"><span>privacy</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Speeding up pip's Windows CI by setting TEMP to the D: drive</h1><div class=post-description>By simply moving all temporary file I/O onto the D: drive, pip's Windows CI times decreased by up to 30% on GitHub Actions.</div><div class=post-meta><span class=post-date title='Posted on 2025-03-10 00:00:00 -0400 EDT'>March 10, 2025</span><span class=delimiter>&nbsp;¬∑&nbsp;</span>7 minutes</div></header><div class=post-content><link rel=stylesheet href=/css/vendors/admonitions.5c73bad2903e7d2d44ad118370ebd8c2cf5f239d4d93c283e55c00f2f8d30746.css integrity="sha256-XHO60pA+fS1ErRGDcOvYws9fI51Nk8KD5VwA8vjTB0Y=" crossorigin=anonymous><div class="admonition conclusion"><div class=admonition-header><svg viewBox="0 0 576 512"><path d="M0 64C0 28.7 28.7.0 64 0H224v128c0 17.7 14.3 32 32 32h128v38.6C310.1 219.5 256 287.4 256 368c0 59.1 29.1 111.3 73.7 143.3-3.2.5-6.4.7-9.7.7H64c-35.3.0-64-28.7-64-64V64zm384 64H256V0L384 128zM288 368a144 144 0 11288 0 144 144 0 11-288 0zm211.3-43.3c-6.2-6.2-16.4-6.2-22.6.0L416 385.4l-28.7-28.7c-6.2-6.2-16.4-6.2-22.6.0s-6.2 16.4.0 22.6l40 40c6.2 6.2 16.4 6.2 22.6.0l72-72c6.2-6.2 6.2-16.4.0-22.6z"/></svg>
<span>TL;DR</span></div><div class=admonition-content><p>If your GHA Windows jobs are I/O heavy, double check whether the I/O work is happening
on the C: drive (OS) or D: drive (working space). If the C: drive is being used, you
will likely benefit by <strong>moving that work to the D: drive</strong>. If you&rsquo;re feeling more
adventurous, you should also <strong>consider trying a ReFS/Dev Drive</strong>.</p></div></div><p>A few weeks ago, I was waiting for pip&rsquo;s CI to turn üçè so I could merge a PR. I&rsquo;d just
spent an hour on review and had pushed a few final tweaks. Waiting an additional 20
minutes was the last thing I wanted to do.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>I was sufficiently annoyed with checking and re-checking the CI status, so I enabled
<a href=https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/incorporating-changes-from-a-pull-request/automatically-merging-a-pull-request target=_blank>auto-merging on the repository</a> so I could at least focus my attention on something
entirely different while waiting for CI to pass. That smoothed over the pain, but it got
me wondering, can pip&rsquo;s tests (and CI in particular) be faster?</p><p>It turns out for the Windows CI jobs, the answer was: <strong>yes, they could be <em>much</em>
faster.</strong></p><h2 id=how-slow-was-pips-windows-ci>How slow was pip&rsquo;s Windows CI?<a hidden class=anchor aria-hidden=true href=#how-slow-was-pips-windows-ci>#</a></h2><p>At the time of writing<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, pip&rsquo;s Github Actions CI workflow consists of 28 jobs. 23
run the test suite across Ubuntu, macOS, Windows, and CPython 3.8 through 3.13.</p><ul><li>7 on the <code>ubuntu-latest</code> runners</li><li>6 on the <code>macos-latest</code> (ARM) runners</li><li>6 on the <code>macos-13</code> (Intel) runners</li><li>4 on the <code>windows-latest</code> runners</li></ul><p>The extra Ubuntu job runs the functional test suite against a <a href=https://pip.pypa.io/en/stable/installation/#standalone-zip-application target=_blank>zipapp</a> version of pip.</p><p>On the other hand, the Windows jobs have historically been so slow that we don&rsquo;t even test
pip across the entire supported Python version matrix. We only test the oldest and newest
version, 3.8 and 3.13, on Windows. Plus, the test suite is
<a href=https://github.com/pypa/pip/blob/ffbf6f0ce61170d6437ad5ff3a90086200ba9e2a/.github/workflows/ci.yml#L183-L185 target=_blank>sharded over two jobs per version</a> because‚Äîas you can probably guess‚Äîthe Windows jobs are
that much slower üêå.</p><p>I wrote a script that queries the GitHub API and calculates the average job duration over
the last X successful runs. As a baseline, this is what pip&rsquo;s CI looked like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-text data-lang=text><span style=display:flex><span>                    Last 50 CI runs on main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Job                            Mean    Minimum   Stdev
</span></span><span style=display:flex><span> ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
</span></span><span style=display:flex><span>  tests / 3.10 / macos-latest    6:25    5:44      0:34 (8%)
</span></span><span style=display:flex><span>  tests / 3.11 / macos-latest    6:40    6:03      0:39 (9%)
</span></span><span style=display:flex><span>  tests / 3.9 / macos-latest     6:57    6:03      0:55 (13%)
</span></span><span style=display:flex><span>  tests / 3.13 / macos-latest    6:59    6:15      0:37 (8%)
</span></span><span style=display:flex><span>  tests / 3.12 / macos-latest    7:09    6:14      1:01 (14%)
</span></span><span style=display:flex><span>  tests / 3.8 / macos-latest     7:11    6:32      0:31 (7%)
</span></span><span style=display:flex><span>  tests / 3.11 / ubuntu-latest   9:33    9:08      0:10 (1%)
</span></span><span style=display:flex><span>  tests / 3.10 / ubuntu-latest   10:04   9:43      0:14 (2%)
</span></span><span style=display:flex><span>  tests / 3.12 / ubuntu-latest   10:34   10:16     0:14 (2%)
</span></span><span style=display:flex><span>  tests / 3.13 / ubuntu-latest   10:35   10:10     0:12 (2%)
</span></span><span style=display:flex;background-color:#3c3d38><span>  tests / 3.13 / Windows / 2     10:39   9:55      0:20 (3%)
</span></span><span style=display:flex><span>  tests / 3.8 / ubuntu-latest    11:02   10:41     0:14 (2%)
</span></span><span style=display:flex;background-color:#3c3d38><span>  tests / 3.13 / Windows / 1     11:13   10:29     0:24 (3%)
</span></span><span style=display:flex><span>  tests / 3.9 / ubuntu-latest    11:44   11:20     0:19 (2%)
</span></span><span style=display:flex><span>  tests / 3.10 / macos-13        12:10   8:53      2:16 (18%)
</span></span><span style=display:flex><span>  tests / 3.11 / macos-13        12:59   9:09      2:34 (19%)
</span></span><span style=display:flex><span>  tests / 3.13 / macos-13        12:59   9:54      2:41 (20%)
</span></span><span style=display:flex><span>  tests / 3.9 / macos-13         13:10   10:09     2:42 (20%)
</span></span><span style=display:flex><span>  tests / 3.8 / macos-13         13:34   10:09     2:30 (18%)
</span></span><span style=display:flex><span>  tests / 3.12 / macos-13        13:55   9:54      3:23 (24%)
</span></span><span style=display:flex;background-color:#3c3d38><span>  tests / 3.8 / Windows / 2      14:58   14:04     0:26 (2%)
</span></span><span style=display:flex><span>  tests / zipapp                 16:53   16:27     0:15 (1%)
</span></span><span style=display:flex;background-color:#3c3d38><span>  tests / 3.8 / Windows / 1      17:37   16:40     0:30 (2%)
</span></span></code></pre></div><p>Among the slowest three jobs, the Windows 3.8 jobs hold the 3rd and 1st places for
duration. Yikes!</p><h3 id=windows-file-io-is-poor-on-github-actions>Windows file I/O is poor on GitHub Actions<a hidden class=anchor aria-hidden=true href=#windows-file-io-is-poor-on-github-actions>#</a></h3><p><a href=https://github.com/actions/runner-images/issues/8755 target=_blank><strong>It&rsquo;s a known issue that file I/O on the Windows runners is noticeably slower</strong></a>
than the Ubuntu and macOS runners.</p><p>As a package installer, <strong>pip&rsquo;s test suite is especially I/O heavy</strong>. Most functional
tests require at least setting a scratch environment and installing something into it.
Countless files and directories are created, opened, and deleted during a run.</p><h2 id=moving-temp-to-the-d-drive>Moving TEMP to the D: drive<a hidden class=anchor aria-hidden=true href=#moving-temp-to-the-d-drive>#</a></h2><p><a href=https://github.com/pypa/pip/pull/13123#issuecomment-2561079373 target=_blank>According to Steve Dower</a>, the GHA Windows workers have a <strong>slow</strong> (but read-optimized)
<strong>C: system drive and a faster D: drive for working space</strong>.</p><div class="admonition warning"><div class=admonition-header><svg viewBox="0 0 512 512"><path d="M256 32c14.2.0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7.2 40.1S486.3 480 472 480H40c-14.3.0-27.6-7.7-34.7-20.1s-7-27.8.2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3.0-24 10.7-24 24v112c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 10-64 0 32 32 0 1064 0z"/></svg>
<span>Warning</span></div><div class=admonition-content><p>Only the standard Windows runners have a D: drive. The larger (paid) Window
runners do NOT have a D: drive. For such situations,
<a href=#what-about-refs-or-dev-drives>ReFS/Dev Drives should be considered</a>.</p></div></div><p>For many projects, this is <em>probably</em> fine. The repository is still checked out on the D:
drive. Any files you create in the checkout will be on the D: drive. For pip&rsquo;s test suite,
however, all of the temporary files are created under the system temporary directory.
Where is this path set to by default? On the C: drive at
<code>C:/Users/runneradmin/AppData/Local/Temp/</code>.<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><p>Thus, pip&rsquo;s CI was being slowed down by reading and writing primarily to the
non-performant disk.</p><p>The good news is that this can be overridden by setting the <code>TEMP</code> environment variable
which Python&rsquo;s <code>tempfile</code> will respect.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Set TEMP to D:/Temp</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          mkdir &#34;D:\\Temp&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          echo &#34;TEMP=D:\\Temp&#34; &gt;&gt; $env:GITHUB_ENV</span>          
</span></span></code></pre></div><p><a href=https://github.com/pypa/pip/pull/13129 target=_blank>This simple switch to <code>D:/Temp</code></a> translated into the Windows CI time <strong>decreasing
by up to 30%</strong>. üéâ</p><table><thead><tr><th>Job</th><th>Before</th><th>After</th><th>% decrease</th></tr></thead><tbody><tr><td>Python 3.8 (1)</td><td>17m 37s</td><td>12m 41s</td><td>28%</td></tr><tr><td>Python 3.8 (2)</td><td>14m 58s</td><td>10m 44s</td><td>28%</td></tr><tr><td>Python 3.13 (1)</td><td>11m 13s</td><td>9m 53s</td><td>11%</td></tr><tr><td>Python 3.13 (2)</td><td>10m 39s</td><td>9m 32s</td><td>10%</td></tr></tbody></table><p>Or in graph form (<strong>note</strong>: the data shown here is slightly more recent than the
statistics).</p><p><img alt=image loading=lazy src=/blog/2025/03/faster-pip-ci-on-windows-d-drive/windows-ci-times.png></p><h2 id=what-about-refs-or-dev-drives>What about ReFS or Dev Drives?<a hidden class=anchor aria-hidden=true href=#what-about-refs-or-dev-drives>#</a></h2><p>When I was investigating ways to improve file I/O performance on Windows, I&rsquo;d discovered
<strong><a href=https://blogs.windows.com/windowsdeveloper/2023/06/01/dev-drive-performance-security-and-control-for-developers/ target=_blank>Dev Drives</a></strong>. Now, I am no Windows expert. I stopped using the OS on a daily basis
many years ago, but the TL;DR is they are a new kind of storage volume, built on the
modern ReFS (Resilient File System) filesystem and <strong>designed with developer workloads in
mind</strong>.</p><p>The
<a href=https://github.com/astral-sh/uv/pull/3522 target=_blank>uv project has had good success with using ReFS to speed up their Windows GHA jobs</a>,
thus I actually started with a ReFS drive<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> while optimising pip&rsquo;s Windows CI.
Unfortunately, using a ReFS drive
<a href=https://github.com/pypa/pip/pull/13129 target=_blank>was noticeably slower than simply moving <code>TEMP</code> to the D: drive</a>. ReFS did save ~a
minute for <code>Python 3.8 (1)</code> but that pales in comparison with the nearly five minutes
improvement from <code>TEMP=D:/Temp</code>.</p><p>The performance improvements of ReFS/Dev Drives are primarily realized by <strong>deferring
malware scans</strong> (Dev Drive only) and the <strong>inherent optimizations of the newer ReFS
filesystem</strong>. Presumably the malware scans are already disabled on GitHub Actions, which
would explain why pip&rsquo;s CI did not see as big of an improvement as I was expecting.</p><p>Given uv&rsquo;s success with ReFS, I can&rsquo;t universally recommend using the D: drive over
ReFS/Dev Drives, and vice versa. <strong>Which one will be faster is likely workload
dependent.</strong> If you would like to experiment with ReFS/Dev Drives, my Powershell script to
<a href=https://github.com/pypa/pip/blob/483859b240109f9c149d7dbf32f4c7f858821e55/tools/ci/devdrive.ps1 target=_blank>create such a drive can be found here</a>. To invoke it, simply pass the desired
drive letter and volume size: <code>devdrive.ps1 -Drive R -Size 4GB</code>.</p><p>Happy experimenting!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Before you kill me for complaining, let me provide some context&mldr; When I used to
maintain Black, I never really noticed how CI took. Most of the jobs would finish in
3-6 minutes. Short enough that I could look over my changes one last time, add notes
as comments, and then come back to merge.<br><br>I did notice that Black&rsquo;s test suite was
slow, taking a good few minutes on the slow laptop I had at that time. I took a look
at the test logic, <a href=https://github.com/psf/black/pull/2205 target=_blank>trimmed redundant work</a>, and
<a href=https://github.com/psf/black/pull/2196 target=_blank>added pytest-xdist for parallelized testing</a>. Afterwards, local test suite runs took
less a minute!<br><br>I was spoiled by Black&rsquo;s fast tests and CI, admittedly.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>I wrote the majority of this post in January&mldr;&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>We&rsquo;ve actually set it to <code>C:/Temp</code> to work around <a href=https://github.com/pypa/pip/actions/runs/12450425946/job/34757228568/#step:8:2982 target=_blank>filename too long errors</a>. Also,
the exact default system temporary directory may vary from worker to worker. I don&rsquo;t
feel like double checking this.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>When I did my experiments, the Windows GHA runners did not support Dev Drives. Only
ReFS was supported.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ichard26.github.io/tags/pip/>Pip</a></li></ul><nav class=paginav><a class=prev href=https://ichard26.github.io/blog/2025/04/whats-new-in-pip-25.1/><span class=title>¬´ Newer</span><br><span>What's new in pip 25.1 - Dependency groups!</span>
</a><a class=next href=https://ichard26.github.io/blog/2025/01/whats-new-in-pip-25.0/><span class=title>Older ¬ª</span><br><span>What's new in pip 25.0</span></a></nav></footer></article></main><footer class=footer><span>¬© 2022-present, Richard Si</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>