<!doctype html><html lang=en-ca dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Compiling Black with mypyc, Pt. 3 - Deployment | Richard Si</title>
<meta name=keywords content="black,mypyc"><meta name=description content="mypyc can compile Black and provide respectable performance gains, let's deploy it in production!"><meta name=author content><link rel=canonical href=https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-3/><link crossorigin=anonymous href=/assets/css/stylesheet.c561bb4cd74c32ad921468fd729afba00f07689dba84e3838699ef9804886852.css integrity="sha256-xWG7TNdMMq2SFGj9cpr7oA8HaJ26hOODhpnvmASIaFI=" rel="preload stylesheet" as=style><link rel=icon href=https://ichard26.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ichard26.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ichard26.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ichard26.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ichard26.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en-ca href=https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=ichard26.github.io src=https://webstats.internal.floralily.dev/js/script.outbound-links.js></script><meta name=google-site-verification content="4PNzC3Db8jI_wn9D8lPdAh4B0skrLZHNbQBgVF1XtAo"><meta property="og:url" content="https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-3/"><meta property="og:site_name" content="Richard Si"><meta property="og:title" content="Compiling Black with mypyc, Pt. 3 - Deployment"><meta property="og:description" content="mypyc can compile Black and provide respectable performance gains, let's deploy it in production!"><meta property="og:locale" content="en-ca"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-05-31T16:27:00-04:00"><meta property="article:modified_time" content="2023-01-03T23:09:00-05:00"><meta property="article:tag" content="Black"><meta property="article:tag" content="Mypyc"><meta name=twitter:card content="summary"><meta name=twitter:title content="Compiling Black with mypyc, Pt. 3 - Deployment"><meta name=twitter:description content="mypyc can compile Black and provide respectable performance gains, let's deploy it in production!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://ichard26.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Compiling Black with mypyc, Pt. 3 - Deployment","item":"https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Compiling Black with mypyc, Pt. 3 - Deployment","name":"Compiling Black with mypyc, Pt. 3 - Deployment","description":"mypyc can compile Black and provide respectable performance gains, let's deploy it in production!","keywords":["black","mypyc"],"articleBody":"This is part of the ‚ÄúCompiling Black with mypyc‚Äù series.\nPt. 1 - Initial Steps Pt. 2 - Optimization Pt. 3 - Deployment (you‚Äôre reading this one) Building compiled wheels with GitHub Actions With the mypyc branch functional and pretty fast, it was time to automate building the wheels. Not only does this make the release process easier, but it also means I can easily build wheels for platforms I don‚Äôt have access to, like MacOS.\nTo make the CI configuration process easier, I finally took a look at cibuildwheel. I won‚Äôt go into my exact process since it was basically trial and error + my many dumb mistakes üòÖ 1 but here are some noteworthy takeaways:\nIf you‚Äôre using setuptools-scm, you might have to do a full clone on CI so the tag history is still available by build time\nRead cibuildwheel‚Äôs documentation before writing any configuration! Seriously, if I did I wouldn‚Äôt have to make this commit adding {project} to the test command\nSet CIBW_BUILD_VERBOSITY to at least 1 because it will make debugging build errors (and trust me you will get some!) so much nicer\nIf wheel sizes are an issue then passing debug_level=0 to mypyc.build.mypycify should help by stripping all debug information. Not great if you hit a bunch of segfaults or similar though, so it‚Äôs a tradeoff\nSo yeah, 20-ish commits later I had a basic but functional setup which could compile wheels for x86-64 Windows, MacOS, and Linux from CPython 3.6 to CPython 3.10. Universial2 and ARM variants are also supported for the shiny M1 platform. The workflow is a bit slow, but that‚Äôs expected and not a big deal.\nIf you‚Äôre curious, you can find the workflow here: ichard26/black-mypyc-wheels\nI don‚Äôt recommend using my workflow to build your own wheels since it‚Äôs a bit hacky and in need of a cleanup. I‚Äôd instead recommend taking a look at the examples in cibuildwheel‚Äôs docs.\nI was going to mention the community field testing campaign I carried out that had its own package index, but honestly it was for the most part a failure as it reached no one. In hindsight, I did not promote it enough so yeah this one is on me :)\nStable release prep and shipping the wheels Black for the longest time ever wasn‚Äôt stable (see GH-517). The team initially aimed to stabilize Black in late 2018, but that didn‚Äôt happen for reasons. I won‚Äôt go into it too much since it‚Äôd be a whole other story, but suffice to say when we made our newest ‚Äúcommitment‚Äù (at that point we explicitly worded our intentions to not be promises) we were very motivated to get it done and hopefully right.\nWe drafted a stability policy, dropped Python 2 support, introduced the --preview flag, and so much more 2.\nIn this time I rewrote diff-shades into what it is today, a reliable enough tool used to provide direct feedback on PRs. I tried to integrate it into the wheel build workflow as part of the test step, but that turned out be very painful and I backed out of it since I had a stable release to manage and publish!\nThe TL;DR of it is as follows:\nBuilding Black with mypyc usually requires disabling pip‚Äôs build isolation to work properly as mypyc is not a standard build dependency of Black. This messes up the installation of diff-shades which is packaged using flit. So I hacked up a script to edit the [build-system].requires field in pyproject.toml to include mypyc pre-build, but the isolation somehow broke the linker search path or something.\nclang -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -g0 -fPIC -I/tmp/pip-build-env-9bfrmy6j/overlay/lib/python3.7/site-packages/mypyc/lib-rt -Ibuild -I/opt/python/cp37-cp37m/include/python3.7m -c build/__native_f2d4935fd652bc9ef29d.c -o build/temp.linux-x86_64-3.7/build/__native_f2d4935fd652bc9ef29d.o -O3 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option clang -shared -g0 build/temp.linux-x86_64-3.7/build/__native_f2d4935fd652bc9ef29d.o -o build/lib.linux-x86_64-3.7/f2d4935fd652bc9ef29d__mypyc.cpython-37m-x86_64-linux-gnu.so /usr/bin/ld: cannot find crtbeginS.o: No such file or directory /usr/bin/ld: cannot find -lgcc /usr/bin/ld: cannot find -lgcc_s clang: error: linker command failed with exit code 1 (use -v to see invocation) error: command '/usr/bin/clang' failed with exit code 1 I honestly still have no idea what‚Äôs wrong.\nAnyway since I was like an hour or more into build errors, I just decided to stop and fall back to the basic testing that was already working.3 I triggered the last workflow run of the day, downloaded the artifacts, tested one of them locally to make sure nothing was on fire, and pushed ‚Äôem to PyPI and that‚Äôs how release 22.1.0 was born üéâ.\nThe core team chat was quite lively for the next hour, to say the least; after all, we just finished a major milestone! Also yeah, we may have done a lot of publicizing for this release which is why it was everywhere for a while :wink:\nPost release calm To be honest I haven‚Äôt really seen anyone comment on the fact Black is now compiled with mypyc yet short of this one mini blog post4 ‚Ä¶ which is both disappointing since I spent so much time on this effort, but also calming since usually buzz is sparked by bugs and whatnot.\nHaving mentioned bugs and crashes, so far we‚Äôve received two reports, one bug probably from mypyc and another due to an unintentional restriction of Black‚Äôs unofficial APIs.\nVersion 22.1.0 still unintentionally broke quite a few integrations, though they weren‚Äôt mypyc related. Turns out lots of people depend on black.files.find_project_root returning a pathlib.Path and nothing else! I‚Äôve seen at least five issues / PRs on GitHub fixing crashes related to our change making it return a tuple instead.\nFor this reason we, the core team, want to define a stable API (GH-779) soon. I can‚Äôt promise anything as Black‚Äôs development is volunteer-based, but if you were curious to what‚Äôs next for psf/black, there‚Äôs this.\nResults \u0026 final thoughts Black is now overall 2 times faster5. And as a bonus, startup time is down too (at most by 15%). You can read the whole report here. Please note these numbers were gathered quite a long time ago and they are probably a bit outdated, especially with the somewhat recent blib2to3 changes made to support 3.10 syntax. If you‚Äôd like to see what all of this work looked in PR form, here ya go.\nFrom my experience, I believe mypyc will make for an interesting, but viable solution to speeding up Python code going forward. It‚Äôs far from perfect and still has a bunch of bugs, but today it is already making an impact. I don‚Äôt recommend using mypyc unless you are willing to feel a bit like a beta tester and have an exhaustive test suite, but hey I managed to do all of this without knowing much about programming in C6, which says a lot.\nGoing forward these open issues remain:\npre-commit is still slow: since pre-commit downloads hooks from source, the compiled wheels won‚Äôt be used. This is a shame since Black‚Äôs speed is noticeable during git commits. I suspect we will have to introduce a shim like mypy‚Äôs pre-commit/mirrors-mypy, but that will be a painful transition.\nWheel building is slow: this is because how mypyc‚Äôs setuptools integration works with PEP 517 builds. The source code ends up being parsed, type checked, and transcompiled twice during a build. pypa/hatch might be a good way to fix this assuming its mypyc plugin doesn‚Äôt suffer the same flaw.\nWe‚Äôre stuck on mypyc 0.920: a change to newer versions broke our usage of dataclasses and it still hasn‚Äôt been fixed ‚Ä¶\nI‚Äôm optimistic that it‚Äôs only a matter of time before all of these issues are resolved.\nI hope to see the mypyc project gain more contributors and succeed. Along with Cython, PyPy, and the faster-cpython project, perhaps Python will finally have a solid speed story.\nAnd yes, I did indeed learn a ton embarking on this project. Made mistakes along the way, but they turned out alright ‚ùÄ\nCongrats on reaching the end of this multi-part blog series!\nBy the way, Glyph has also written an excellent piece on mypyc where he tries to convince you to start using mypyc. You should totally read it.\nIf you would like to chat with me, my contact details are here.\nAcknowledgements I‚Äôd like to thank @msullivan for his original work on integrating mypyc into Black, spawning this summer project and eventually this blog series :)\nI‚Äôd like to also thank @dawnofmidnight, @kosayoda, Jelle Zijlstra, and ≈Åukasz Langa for their extensive feedback and help while writing this series. Any errors are my own, not theirs.\nIf you are in need of some quality entertainment, look at this commit history: https://github.com/ichard26/black-mypyc-wheels/commits/main¬†‚Ü©Ô∏é\nI would link to the 22.1.0 heading, but currently the HTML IDs are uhhh ‚Ä¶ terrible and don‚Äôt persist. I‚Äôve tried fixing this with a custom sphinx extension but it failed. I have other ideas left to try, but yeah :(¬†‚Ü©Ô∏é\nI was frustrated and had a headache thanks to the stress üôÉ¬†‚Ü©Ô∏é\nIn the time it has taken me to edit this series, ≈Åukasz Langa has done a talk about mypyc and Black‚Äôs usage of it.¬†‚Ü©Ô∏é\nOriginally when I first landed the relevant PR it was an overall 2x improvement, but once Jelle added a stability hotfix the effective speedup for files that are changed is 50%. If you‚Äôre formatting a bunch of already well formatted files, the speedup is still 2x¬†‚Ü©Ô∏é\nLearning C (and Rust) is now one of my future goals thanks to this project¬†‚Ü©Ô∏é\n","wordCount":"1566","inLanguage":"en-ca","datePublished":"2022-05-31T16:27:00-04:00","dateModified":"2023-01-03T23:09:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-3/"},"publisher":{"@type":"Person","name":"Richard Si","logo":{"@type":"ImageObject","url":"https://ichard26.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ichard26.github.io/ accesskey=h title="Richard Si (Alt + H)">Richard Si</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ichard26.github.io/about/ title=About><span>about</span></a></li><li><a href=https://ichard26.github.io/blog/ title=Writing><span>writing</span></a></li><li><a href=https://ichard26.github.io/privacy/ title="Privacy Statement"><span>privacy</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Compiling Black with mypyc, Pt. 3 - Deployment</h1><div class=post-description>mypyc can compile Black and provide respectable performance gains, let's deploy it in production!</div><div class=post-meta><span class=post-date title='Posted on 2022-05-31 16:27:00 -0400 -0400'>May 31, 2022</span><span class=delimiter>&nbsp;¬∑&nbsp;</span><span class=last-modified title='Updated on 2023-01-03 23:09:00 -0500 -0500'>Updated on January 3, 2023</span><span class=delimiter>&nbsp;¬∑&nbsp;</span>8 minutes</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#building-compiled-wheels-with-github-actions aria-label="Building compiled wheels with GitHub Actions">Building compiled wheels with GitHub Actions</a></li><li><a href=#stable-release-prep-and-shipping-the-wheels aria-label="Stable release prep and shipping the wheels">Stable release prep and shipping the wheels</a><ul><li><a href=#post-release-calm aria-label="Post release calm">Post release calm</a></li></ul></li><li><a href=#results--final-thoughts aria-label="Results & final thoughts">Results & final thoughts</a></li><li><a href=#acknowledgements aria-label=Acknowledgements>Acknowledgements</a></li></ul></div></details></div><div class=post-content><p>This is part of the &ldquo;<em>Compiling Black with mypyc</em>&rdquo; series.</p><ul><li><a href=../compiling-black-with-mypyc-part-1/>Pt. 1 - Initial Steps</a></li><li><a href=../compiling-black-with-mypyc-part-2/>Pt. 2 - Optimization</a></li><li><a href=.>Pt. 3 - Deployment</a> (you&rsquo;re reading this one)</li></ul><h2 id=building-compiled-wheels-with-github-actions>Building compiled wheels with GitHub Actions<a hidden class=anchor aria-hidden=true href=#building-compiled-wheels-with-github-actions>#</a></h2><p>With the mypyc branch functional and pretty fast, it was time to automate building the
wheels. Not only does this make the release process easier, but <strong>it also means I can
easily build wheels for platforms I don&rsquo;t have access to</strong>, like MacOS.</p><p>To make the CI configuration process easier, I finally took a look at <a href=https://cibuildwheel.readthedocs.io/en/stable/ target=_blank>cibuildwheel</a>. I
won&rsquo;t go into my exact process since it was basically trial and error + my many dumb
mistakes üòÖ <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> but here are some noteworthy takeaways:</p><ul><li><p>If you&rsquo;re using <code>setuptools-scm</code>, you might have to do a full clone on CI so the tag
history is still available by build time</p></li><li><p><strong>Read cibuildwheel&rsquo;s documentation before writing any configuration!</strong> Seriously, if I
did I wouldn&rsquo;t have to make <a href=https://github.com/ichard26/black-mypyc-wheels/commit/643de450e252e74040ba14fd066ea8bc23c0b0d7 target=_blank>this commit</a> adding <code>{project}</code> to
the test command</p></li><li><p>Set <code>CIBW_BUILD_VERBOSITY</code> to at least <code>1</code> because it will make debugging build errors
(and trust me you will get some!) so much nicer</p></li><li><p>If wheel sizes are an issue then passing <code>debug_level=0</code> to <code>mypyc.build.mypycify</code>
should help by stripping all debug information. Not great if you hit a bunch of
segfaults or similar though, so it&rsquo;s a tradeoff</p></li></ul><p>So yeah, 20-ish commits later I had a basic but functional setup which could compile
wheels for x86-64 Windows, MacOS, and Linux from CPython 3.6 to CPython 3.10. Universial2
and ARM variants are also supported for the shiny M1 platform. The workflow is a bit slow,
but that&rsquo;s expected and not a big deal.</p><p>If you&rsquo;re curious, you can find the workflow here: <a href=https://github.com/ichard26/black-mypyc-wheels target=_blank>ichard26/black-mypyc-wheels</a></p><blockquote><p>I don&rsquo;t recommend using my workflow to build your own wheels since it&rsquo;s a bit hacky and
in need of a cleanup. I&rsquo;d instead recommend taking a look at the
<a href=https://cibuildwheel.readthedocs.io/en/stable/working-examples/ target=_blank>examples in cibuildwheel&rsquo;s docs</a>.</p></blockquote><p>I was going to mention the community field testing campaign I carried out that had its own
package index, but honestly it was for the most part a failure as it reached no one. In
hindsight, I did not promote it enough so yeah this one is on me :)</p><h2 id=stable-release-prep-and-shipping-the-wheels>Stable release prep and shipping the wheels<a hidden class=anchor aria-hidden=true href=#stable-release-prep-and-shipping-the-wheels>#</a></h2><p>Black for the longest time ever wasn&rsquo;t stable (see <a href=https://github.com/psf/black/issues/517 target=_blank>GH-517</a>). The team initially aimed to
stabilize Black in late 2018, but that didn&rsquo;t happen for reasons. I won&rsquo;t go into it too
much since it&rsquo;d be a whole other story, but suffice to say when we made our newest
&ldquo;commitment&rdquo; (at that point we explicitly worded our intentions to <em>not</em> be promises) <strong>we
were very motivated to get it done and hopefully right.</strong></p><p>We drafted a <a href=https://black.readthedocs.io/en/latest/the_black_code_style/index.html#stability-policy target=_blank>stability policy</a>,
<a href=https://github.com/psf/black/pull/2740 target=_blank>dropped Python 2 support</a>, <a href=https://github.com/psf/black/issues/2751 target=_blank>introduced the <code>--preview</code> flag</a>,
and <a href=https://black.readthedocs.io/en/stable/change_log.html target=_blank>so much more</a> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>In this time I rewrote diff-shades into <a href=https://github.com/ichard26/diff-shades target=_blank>what it is today</a>, a reliable enough
tool used to <a href=https://github.com/psf/black/pull/2814#issuecomment-1023219426 target=_blank>provide direct</a>
<a href=https://github.com/psf/black/pull/2726#issuecomment-1019067134 target=_blank>feedback on PRs</a>. I tried to integrate it into the wheel build
workflow as part of the test step, but that turned out be very painful and I backed out of
it since I had a stable release to manage and publish!</p><p><em>The TL;DR of it is as follows:</em></p><p>Building Black with mypyc usually requires disabling pip&rsquo;s build isolation to work
properly as mypyc is not a standard build dependency of Black. This messes up the
installation of diff-shades which is packaged using flit. So I hacked up a script to edit
the <code>[build-system].requires</code> field in <code>pyproject.toml</code> to include mypyc pre-build, but
the isolation somehow broke the linker search path or something.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>clang -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -g0 -fPIC -I/tmp/pip-build-env-9bfrmy6j/overlay/lib/python3.7/site-packages/mypyc/lib-rt -Ibuild -I/opt/python/cp37-cp37m/include/python3.7m -c build/__native_f2d4935fd652bc9ef29d.c -o build/temp.linux-x86_64-3.7/build/__native_f2d4935fd652bc9ef29d.o -O3 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option
</span></span><span style=display:flex><span>    clang -shared -g0 build/temp.linux-x86_64-3.7/build/__native_f2d4935fd652bc9ef29d.o -o build/lib.linux-x86_64-3.7/f2d4935fd652bc9ef29d__mypyc.cpython-37m-x86_64-linux-gnu.so
</span></span><span style=display:flex><span>    /usr/bin/ld: cannot find crtbeginS.o: No such file or directory
</span></span><span style=display:flex><span>    /usr/bin/ld: cannot find -lgcc
</span></span><span style=display:flex><span>    /usr/bin/ld: cannot find -lgcc_s
</span></span><span style=display:flex><span>    clang: error: linker command failed with exit code 1 (use -v to see invocation)
</span></span><span style=display:flex><span>    error: command &#39;/usr/bin/clang&#39; failed with exit code 1
</span></span></code></pre></div><p>I honestly still have no idea what&rsquo;s wrong.</p><p>Anyway since I was like an hour or more into build errors, I just decided to stop and fall
back to the basic testing that was already working.<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> I triggered the last workflow run
of the day, downloaded the artifacts, tested one of them locally to make sure nothing was
on fire, and pushed &rsquo;em to PyPI and that&rsquo;s how release 22.1.0 was born üéâ.</p><p>The core team chat was quite lively for the next hour, to say the least; after all, we
just finished a major milestone! Also yeah, we <em>may</em> have done a lot of publicizing for
this release which is why it was everywhere for a while :wink:</p><h3 id=post-release-calm>Post release calm<a hidden class=anchor aria-hidden=true href=#post-release-calm>#</a></h3><p>To be honest I haven&rsquo;t really seen anyone comment on the fact Black is now compiled with
mypyc yet short of this one <a href=https://simonwillison.net/2022/Jan/30/mypyc/ target=_blank>mini blog post</a><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> &mldr;
which is both disappointing since I spent so much time on this effort, but also calming
since usually buzz is sparked by bugs and whatnot.</p><p>Having mentioned bugs and crashes, so far we&rsquo;ve received two reports,
<a href=https://github.com/psf/black/issues/2846 target=_blank>one bug probably from mypyc and another due to an unintentional restriction of Black&rsquo;s unofficial APIs</a>.</p><p>Version 22.1.0 still unintentionally broke quite a few integrations, though they weren&rsquo;t
mypyc related. Turns out lots of people depend on <code>black.files.find_project_root</code>
returning a <code>pathlib.Path</code> and nothing else! I&rsquo;ve seen at least five issues / PRs on
GitHub fixing crashes related to our change making it return a tuple instead.</p><p>For this reason we, the core team, want to <a href=https://github.com/psf/black/issues/779 target=_blank>define a stable API (GH-779)</a> soon. I
can&rsquo;t promise anything as Black&rsquo;s development is volunteer-based, but if you were curious
to what&rsquo;s next for psf/black, there&rsquo;s this.</p><h2 id=results--final-thoughts>Results & final thoughts<a hidden class=anchor aria-hidden=true href=#results--final-thoughts>#</a></h2><p><strong>Black is now overall 2 times faster</strong><sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>. And as a bonus, startup time is down too (at
most by 15%). You can <a href=https://gist.github.com/ichard26/b996ccf410422b44fcd80fb158e05b0d target=_blank>read the whole report here</a>. Please note these numbers
were gathered quite a long time ago and <strong>they are probably a bit outdated</strong>, especially
with the somewhat recent blib2to3 changes made to support 3.10 syntax. If you&rsquo;d like to
see what all of this work looked in PR form, <a href=https://github.com/psf/black/pull/2431 target=_blank>here ya go</a>.</p><p>From my experience, I believe mypyc will make for an interesting, but viable solution to
speeding up Python code going forward. It&rsquo;s far from perfect and still has a bunch of
bugs, but today it is already making an impact. I don&rsquo;t recommend using mypyc unless you
are willing to feel a bit like a beta tester <em>and</em> have an exhaustive test suite, but
<strong>hey I managed to do all of this without knowing much about programming in C</strong><sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>,
which says a lot.</p><p>Going forward these open issues remain:</p><ul><li><p><strong>pre-commit is still slow</strong>: since pre-commit downloads hooks from source, the compiled
wheels won&rsquo;t be used. This is a shame since Black&rsquo;s speed is noticeable during git
commits. I suspect we will have to introduce a shim like mypy&rsquo;s
<a href=https://github.com/pre-commit/mirrors-mypy target=_blank>pre-commit/mirrors-mypy</a>, but that will be a painful transition.</p></li><li><p><strong>Wheel building is slow</strong>: this is because how mypyc&rsquo;s setuptools integration works
with PEP 517 builds. The source code ends up being parsed, type checked, and
transcompiled twice during a build. <a href=https://github.com/pypa/hatch target=_blank>pypa/hatch</a> might be a good way to fix this
assuming its mypyc plugin doesn&rsquo;t suffer the same flaw.</p></li><li><p><strong>We&rsquo;re stuck on mypyc 0.920</strong>: a change to newer versions broke our usage of
dataclasses and it still hasn&rsquo;t been fixed &mldr;</p></li></ul><p>I&rsquo;m optimistic that it&rsquo;s only a matter of time before all of these issues are resolved.</p><p>I hope to see the mypyc project gain more contributors and succeed. Along with Cython,
PyPy, and the faster-cpython project, <strong>perhaps Python will finally have a solid speed
story</strong>.</p><blockquote><p>And yes, I did indeed learn a ton embarking on this project. Made mistakes along the
way, but they turned out alright ‚ùÄ</p></blockquote><p>Congrats on reaching the end of this multi-part blog series!</p><p><em>By the way, <a href=https://glyph.twistedmatrix.com/2022/04/you-should-compile-your-python-and-heres-why.html target=_blank>Glyph has also written an excellent piece on mypyc</a> where he tries to
convince you to start using mypyc. You should totally read it.</em></p><p><em>If you would like to chat with me, <a href=https://ichard26.github.io/about/#contact-information target=_blank>my contact details are here</a>.</em></p><h2 id=acknowledgements>Acknowledgements<a hidden class=anchor aria-hidden=true href=#acknowledgements>#</a></h2><p>I&rsquo;d like to thank <a href=https://github.com/msullivan target=_blank>@msullivan</a> for his original work on integrating mypyc into Black,
spawning this summer project and eventually this blog series :)</p><p>I&rsquo;d like to also thank <a href=https://github.com/dawnofmidnight target=_blank>@dawnofmidnight</a>, <a href=https://github.com/kosayoda target=_blank>@kosayoda</a>, <a href=https://github.com/JelleZijlstra target=_blank>Jelle Zijlstra</a>,
and <a href=https://github.com/ambv target=_blank>≈Åukasz Langa</a> for their extensive feedback and help while writing this series.
Any errors are my own, not theirs.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>If you are in need of some quality entertainment, look at this commit history:
<a href=https://github.com/ichard26/black-mypyc-wheels/commits/main target=_blank>https://github.com/ichard26/black-mypyc-wheels/commits/main</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>I would link to the 22.1.0 heading, but currently the HTML IDs are uhhh &mldr; terrible
and don&rsquo;t persist. I&rsquo;ve tried fixing this with a custom sphinx extension but it
failed. I have other ideas left to try, but yeah :(&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>I was frustrated and had a headache thanks to the stress üôÉ&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>In the time it has taken me to edit this series, ≈Åukasz Langa has done a <a href=https://pretalx.com/pycon-lt-2022/talk/BG7LZF/ target=_blank>talk</a> about
mypyc and Black&rsquo;s usage of it.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>Originally when I first landed the relevant PR it was an overall 2x improvement, but
once Jelle added a stability hotfix the <em>effective</em> speedup for files that are changed
is 50%. If you&rsquo;re formatting a bunch of already well formatted files, the speedup is
still 2x&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>Learning C (and Rust) is now one of my future goals thanks to this project&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ichard26.github.io/tags/black/>Black</a></li><li><a href=https://ichard26.github.io/tags/mypyc/>Mypyc</a></li></ul><nav class=paginav><a class=prev href=https://ichard26.github.io/blog/2022/10/black-22.10.0/><span class=title>¬´ Newer</span><br><span>What's new in Black 22.10.0</span>
</a><a class=next href=https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-2/><span class=title>Older ¬ª</span><br><span>Compiling Black with mypyc, Pt. 2 - Optimization</span></a></nav></footer></article></main><footer class=footer><span>¬© 2022-present, Richard Si</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>