<!doctype html><html lang=en-ca dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Compiling Black with mypyc, Pt. 1 - Initial Steps | Richard Si</title>
<meta name=keywords content="black,mypyc"><meta name=description content="I spent a COVID summer (and then some) integrating mypyc into Black to double performance. How was it?"><meta name=author content><link rel=canonical href=https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-1/><link crossorigin=anonymous href=/assets/css/stylesheet.e19d14cf058fa4dd7f4e4c26f3a2d5e21424f9a551aebb184b213575ef166439.css integrity="sha256-4Z0UzwWPpN1/Tkwm86LV4hQk+aVRrrsYSyE1de8WZDk=" rel="preload stylesheet" as=style><link rel=icon href=https://ichard26.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ichard26.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ichard26.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://ichard26.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ichard26.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en-ca href=https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=ichard26.github.io src=https://webstats.internal.floralily.dev/js/script.outbound-links.js></script><meta name=google-site-verification content="4PNzC3Db8jI_wn9D8lPdAh4B0skrLZHNbQBgVF1XtAo"><meta property="og:url" content="https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-1/"><meta property="og:site_name" content="Richard Si"><meta property="og:title" content="Compiling Black with mypyc, Pt. 1 - Initial Steps"><meta property="og:description" content="I spent a COVID summer (and then some) integrating mypyc into Black to double performance. How was it?"><meta property="og:locale" content="en-ca"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-05-31T16:25:00-04:00"><meta property="article:modified_time" content="2022-06-04T21:51:00-04:00"><meta property="article:tag" content="Black"><meta property="article:tag" content="Mypyc"><meta name=twitter:card content="summary"><meta name=twitter:title content="Compiling Black with mypyc, Pt. 1 - Initial Steps"><meta name=twitter:description content="I spent a COVID summer (and then some) integrating mypyc into Black to double performance. How was it?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://ichard26.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Compiling Black with mypyc, Pt. 1 - Initial Steps","item":"https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Compiling Black with mypyc, Pt. 1 - Initial Steps","name":"Compiling Black with mypyc, Pt. 1 - Initial Steps","description":"I spent a COVID summer (and then some) integrating mypyc into Black to double performance. How was it?","keywords":["black","mypyc"],"articleBody":"Release 22.1.0 of Black was special, not only was it the first stable version of Black, it was also the first release to ship with mypyc compiled wheels, doubling performance1 üéâ.\nThe journey getting here took over two years, the creation of two new dev tools, and lots and lots of headscratching. Let‚Äôs go down memory lane, shall we?\nThis is a long story so it‚Äôs broken up into three parts. Collectively this is the Compiling Black with mypyc series.\nPt. 1 - Initial Steps (you‚Äôre reading this one) Pt. 2 - Optimization Pt. 3 - Deployment While I‚Äôd love it if you would read this end to end, I totally understand if this ends up in the ‚Äúto read later‚Äù section of your bookmarks. I just hope you enjoy whatever you do read!\n‚Ä¶ and yes it took me almost 6 months after deploying mypyc to write this.\nIntroduction to mypyc Before I dig into the story of how I integrated mypyc into Black, I want to explain what mypyc is and show an example using it. mypyc is a transcompiler converting typed Python code into fast C extensions. Being built on top of the mypy type checker, it leverages standard type annotations2 (unlike Cython).\nIt has been used to compile mypy (and itself since mypyc comes with mypy) since 2019, giving it a 4x performance boost over interpreted Python. According to the mypyc project:\nExisting code with type annotations is often 1.5x to 5x faster when compiled. Code tuned for mypyc can be 5x to 10x faster.3\nIt achieves these impressive speed ups by:\nUsing the C-API directly, avoiding the CPython interpreter overhead.\nLeveraging early binding, resolving called functions and names at compile-time, skipping the expensive dictionary lookup at runtime.\nUsing optimized, type-specific primitives for many built-in functions and methods.\nUsing custom memory-efficient, unboxed representations for integers and booleans.\nCompiling regular classes to C extension classes. C extension classes use vtables for fast method calls and attribute access.\n‚Ä¶ and other optimizations I‚Äôve left out for the sake of brevity.\nTime for an example Interested? I sure hope so since it‚Äôs time for an example! To get started, create a throwaway directory somewhere, a virtual environment, and install mypy. As of writing I‚Äôm using mypy 0.931 on Ubuntu 20.04.03 with CPython 3.8.5.\nNext, let‚Äôs take a look at the code4 we‚Äôll soon compile. It‚Äôs a simple program that bruteforces its way to find all of the factor pairs for a given product. I mostly chose this example because it‚Äôs very dear to my heart. It was the first ‚Äúserious‚Äù program I wrote while learning Python5. I originally wrote the same logic in code.org‚Äôs app lab many years ago.\nimport time from typing import List, Tuple def compute(product: int) -\u003e List[Tuple[int, int]]: answers = [] for factor in range(1, product + 1): if not product % factor: factor2 = int(product / factor) answers.append((factor, factor2)) return answers t0 = time.perf_counter() compute(27_000_000) elapsed = time.perf_counter() - t0 print(f\"compute() took {elapsed * 1000:.1f} milliseconds\") Once saved, run it noting the time it takes:\n$ python coefficient_finder.py compute() took 1880.7 milliseconds Alright, it‚Äôs a bit slow, let‚Äôs see if mypyc can change that:\n$ mypyc coefficient_finder.py running build_ext creating build/temp.linux-x86_64-3.8 creating build/temp.linux-x86_64-3.8/build gcc -pthread -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/ichard26/programming/webdev/blog/testing-grounds/venv/lib/python3.8/site-packages/mypyc/lib-rt -I/home/ichard26/programming/webdev/blog/testing-grounds/venv/include -I/opt/python3.8.5/include/python3.8 -c build/__native.c -o build/temp.linux-x86_64-3.8/build/__native.o -O3 -g1 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option -Wno-unused-but-set-variable creating build/lib.linux-x86_64-3.8 gcc -pthread -shared build/temp.linux-x86_64-3.8/build/__native.o -o build/lib.linux-x86_64-3.8/coefficient_finder.cpython-38-x86_64-linux-gnu.so $ python -c \"import coefficient_finder\" compute() took 331.6 milliseconds And would you look at that, mypyc gave us a near 6x improvement over CPython! What‚Äôs neat is that I didn‚Äôt even need to type all of the variables thanks to mypy‚Äôs type inference.\nAnd actually, since the mypyc script is a simple wrapper that generates a setuptools project and builds it in-place, you can peek into the build directory and look at the generated C code (should be in __native.c).\nFeel free to edit the program and play around with mypyc, seeing what little scripts it can speed up. Pro-tip, to restore back to the interpreted version of your program, you can delete the .so file on Linux \u0026 MacOS or the .pyd file on Windows. In this example I got coefficient_finder.cpython-38-x86_64-linux-gnu.so.\nIt‚Äôs not a silver bullet There‚Äôs several downsides to using mypyc. While the project aims for excellent compatibility with CPython, there are some major deviations worth noting:\nTypes are enforced at runtime and violations will cause a TypeError (this makes using typing.Any quite dangerous).\nCompiled modules can‚Äôt be run directly, you have to import ‚Äôem instead.\nMonkeypatching anything compiled is unlikely to work as compiled code skips many of the runtime __dict__ lookups normal Python does.\nAssignments to class and instance namespaces will either error or do nothing, in particular you can‚Äôt add previously undeclared attributes later on.\nStandard multiple inheritance isn‚Äôt supported.\nProfilers (e.g. CProfile), debuggers (e.g. pdb), and tracing hooks (e.g. coverage) won‚Äôt work as the C code doesn‚Äôt trigger the relevant hooks.\nThere are more details available in the official mypyc documentation here and also here.\nblack + mypyc: Initial steps I wasn‚Äôt the first person to integrate mypyc into Black; way back in September 2019, @msullivan opened a PR getting Black ready for compilation. Unfortunately, as is typical in open source projects, no one took the half-completed work and pushed it to completion ‚Ä¶ for almost two years.\nYou might be wondering why performance even matters, well clearly it mattered a lot since GH-366 was opened in June 2018! The TL;DR is that for environments where Black is ran on save automatically, the more responsive it is the better as less time is spent in a laggy editor window.\nStart up time is important too given imports are costly (it turns out mypyc can reduce import time too!), but this issue was explicitly about formatting throughput.\nGiven I first publicly announced my work finishing up the project on July 4th 2021, I sadly don‚Äôt remember why I decided to pick it up. All I remember was fighting mypyc compile-time type errors and fighting an outdated gcc‚Ä¶ well OK I do remember I was looking to learn more about type systems and C development in general, but that‚Äôs it, I promise!\nFirst off, as of writing mypyc has a bug (mypyc#885) where its boxing \u0026 unboxing code triggers array subscript 1 is above array bounds on blib2to3.pgen2.parse.Parser.setup. I simplified the reproduction case to the following:\nfrom typing import Optional, Tuple Context = Tuple[str, Tuple[int, int]] RawNode = Tuple[int, Optional[str], Optional[Context]] def setup() -\u003e None: # This is what ticks off gcc. newnode: RawNode = (7, None, None) ‚Ä¶ yeah, I know this makes mypyc look fragile. While it‚Äôs not entirely stupid to use it in production (because I did so), you‚Äôd be right in pointing out it‚Äôs alpha quality and needs careful testing. And to be fair, poor past me didn‚Äôt know just how many issues I‚Äôd soon face. All I can hope is that this work will help mypyc improve ‚ùÄ\nAnyway I switched to clang and this issue disappeared ‚Ä¶\nTrying to compile black and blib2to36 initially seemed like a small task with just these type errors:\n$ python setup.py --use-mypyc bdist_wheel Parsed and typechecked in 8.566s Compiled to C in 0.000s src/black/parsing.py:30:9: error: Cannot assign multiple modules to name \"ast3\" without explicit \"types.ModuleType\" annotation src/black/parsing.py:30:9: error: Cannot assign multiple modules to name \"ast27\" without explicit \"types.ModuleType\" annotation src/black/parsing.py:146:13: error: Incompatible types in assignment (expression has type \"Tuple[Type[typed_ast.ast3.TypeIgnore], Type[typed_ast.ast27.TypeIgnore], Type[_ast.TypeIgnore]]\", variable has type \"Tuple[Type[typed_ast.ast3.TypeIgnore], Type[typed_ast.ast27.TypeIgnore]]\") The ones about Cannot assign multiple modules to name ... are valid if annoying, back then the code in black.parsing was pretty dynamic. The other one was just that mypy under ‚Äúmypyc super-strict mode‚Äù won‚Äôt infer a variable to be a variable-length tuple even if it‚Äôs extended right after:\ndef stringify_ast( node: Union[ast.AST, ast3.AST, ast27.AST], depth: int = 0 ) -\u003e Iterator[str]: \"\"\"Simple visitor generating strings to compare ASTs by content.\"\"\" node = fixup_ast_constants(node) yield f\"{' ' * depth}{node.__class__.__name__}(\" for field in sorted(node._fields): # noqa: F402 # TypeIgnore has only one field 'lineno' which breaks this comparison type_ignore_classes = (ast3.TypeIgnore, ast27.TypeIgnore) if sys.version_info \u003e= (3, 8): type_ignore_classes += (ast.TypeIgnore,) The fix was to add Tuple[Type, ...].\ntype_ignore_classes: Tuple[Type, ...] = (ast3.TypeIgnore, ast27.TypeIgnore) Now, the codebase was able to type check even under ‚Äúmypyc super-strict mode,‚Äù but obviously that just meant I had another class of fires to deal with, *compiler crashes*!\n$ python setup.py --use-mypyc bdist_wheel Parsed and typechecked in 8.929s Compiling cache, strings, black, debug, parsing, brackets, lines, files, literals, conv, trans, linegen, numerics, nodes, const, pgen, pygram, output, token, concurrency, parse, report, mode, driver, grammar, tokenize, pytree, rusty, comments Traceback (most recent call last): File \"mypyc/irbuild/builder.py\", line 169, in accept File \"mypy/nodes.py\", line 950, in accept File \"mypyc/irbuild/visitor.py\", line 104, in visit_class_def File \"mypyc/irbuild/classdef.py\", line 137, in transform_class_def File \"mypyc/irbuild/classdef.py\", line 388, in generate_attr_defaults File \"mypyc/ir/class_ir.py\", line 174, in attr_type File \"mypyc/ir/class_ir.py\", line 171, in attr_details src/black/trans.py:187: KeyError: \"'CustomSplitMapMixin' has no attribute '_Key'\" This issue was just due to missing ClassVar declarations for attributes that are functionally class-only attributes. The fix was pretty easy :)\n+@trait class CustomSplitMapMixin: \"\"\" This mixin class is used to map merged strings to a sequence of @@ -191,8 +204,10 @@ class CustomSplitMapMixin: the resultant substrings go over the configured max line length. \"\"\" - _Key = Tuple[StringID, str] - _CUSTOM_SPLIT_MAP: Dict[_Key, Tuple[CustomSplit, ...]] = defaultdict(tuple) + _Key: ClassVar = Tuple[StringID, str] + _CUSTOM_SPLIT_MAP: ClassVar[Dict[_Key, Tuple[CustomSplit, ...]]] = defaultdict( + tuple + ) Do you see that @trait addition? well ‚Ä¶ mypyc does in fact support a limited form of multiple inheritance called traits. They‚Äôre basically mixins. As noted in the mypyc documentation, they shouldn‚Äôt be instantiated or subclass non-traits.\nAnd as usual, fixing this crash revealed *even* *more* *issues*, albeit mypyc specific this time:\n$ python setup.py --use-mypyc bdist_wheel Parsed and typechecked in 8.122s Compiling pgen, parse, parsing, mode, pytree, token, debug, const, lines, numerics, rusty, conv, comments, files, trans, cache, black, grammar, output, brackets, tokenize, linegen, pygram, report, literals, nodes, strings, concurrency, driver Compiled to C in 0.970s src/black/trans.py:250: error: Non-trait bases must appear first in parent list src/black/trans.py:934: error: Non-trait bases must appear first in parent list src/black/trans.py:1433: error: Non-trait bases must appear first in parent list src/black/brackets.py:52: error: Inheriting from most builtin types is unimplemented src/black/files.py:52: warning: Treating generator comprehension as list src/black/trans.py:746: warning: Unsupported default attribute value src/black/trans.py:1831: warning: Unsupported default attribute value src/blib2to3/pgen2/tokenize.py:430: error: Local variable \"stashed\" has inferred type None; add an annotation src/black/nodes.py:442: error: Local variable \"stop_after\" has inferred type None; add an annotation src/black/nodes.py:443: error: Local variable \"last\" has inferred type None; add an annotation These were pretty straightforward to fix and sometimes even improved code clarity, forcing me to add type annotations in complex code.\nMore changes were necessary than expected All of this was only to get the codebase to type check and not crash the compiler. Getting the built binary to not crash at runtime needed more work. Some of these changes were improvements, like this one which involved an incorrect type annotation:\ndiff --git a/src/black/__init__.py b/src/black/__init__.py index 8e2123d..6998c1e 100644 --- a/src/black/__init__.py +++ b/src/black/__init__.py @@ -359,7 +359,7 @@ def main( experimental_string_processing: bool, quiet: bool, verbose: bool, - required_version: str, + required_version: Optional[str], include: Pattern, exclude: Optional[Pattern], extend_exclude: Optional[Pattern], This goes to show that while the strict runtime type checks can be very annoying, they do have value beyond memory safety.\nSad and frustrating changes ‚Ä¶ but others were just sad or annoying (mixing dataclasses with anything remotely fancy breaks mypyc).\ndiff --git a/src/black/linegen.py b/src/black/linegen.py index 76b553a..1691cc5 100644 --- a/src/black/linegen.py +++ b/src/black/linegen.py @@ -40,7 +38,8 @@ class CannotSplit(CannotTransform): \"\"\"A readable split that fits the allotted line length is impossible.\"\"\" -@dataclass +# This isn't a dataclass because @dataclass + Generic breaks mypyc. +# See also https://github.com/mypyc/mypyc/issues/827. class LineGenerator(Visitor[Line]): \"\"\"Generates reformatted Line objects. Empty lines are not emitted. @@ -48,9 +47,11 @@ class LineGenerator(Visitor[Line]): in ways that will no longer stringify to valid Python code on the tree. \"\"\" - mode: Mode - remove_u_prefix: bool = False - current_line: Line = field(init=False) + def __init__(self, mode: Mode, remove_u_prefix: bool = False) -\u003e None: + self.mode = mode + self.remove_u_prefix = remove_u_prefix + self.current_line: Line + self.__post_init__() def line(self, indent: int = 0) -\u003e Iterator[Line]: \"\"\"Generate a line. diff --git a/src/black/trans.py b/src/black/trans.py index 023dcd3..d918ef1 100644 --- a/src/black/trans.py +++ b/src/black/trans.py @@ -62,7 +71,6 @@ def TErr(err_msg: str) -\u003e Err[CannotTransform]: return Err(cant_transform) -@dataclass # type: ignore class StringTransformer(ABC): \"\"\" An implementation of the Transformer protocol that relies on its @@ -90,9 +98,13 @@ class StringTransformer(ABC): as much as possible. \"\"\" - line_length: int - normalize_strings: bool - __name__ = \"StringTransformer\" + __name__: Final = \"StringTransformer\" + + # Ideally this would be a dataclass, but unfortunately mypyc breaks when used with + # `abc.ABC`. + def __init__(self, line_length: int, normalize_strings: bool) -\u003e None: + self.line_length = line_length + self.normalize_strings = normalize_strings Hackiness += 10000 One change stood out as the most hacky7 code I‚Äôve probably ever written so far:\ndiff --git a/src/black/linegen.py b/src/black/linegen.py index 76b553a..1691cc5 100644 --- a/src/black/linegen.py +++ b/src/black/linegen.py @@ -335,7 +336,9 @@ def transform_line( transformers = [left_hand_split] else: - def rhs(line: Line, features: Collection[Feature]) -\u003e Iterator[Line]: + def _rhs( + self: object, line: Line, features: Collection[Feature] + ) -\u003e Iterator[Line]: \"\"\"Wraps calls to `right_hand_split`. The calls increasingly `omit` right-hand trailers (bracket pairs with @@ -362,6 +365,11 @@ def transform_line( line, line_length=mode.line_length, features=features ) + # HACK: functions (like rhs) compiled by mypyc don't retain their __name__ + # attribute which is needed in `run_transformer` further down. Unfortunately + # a nested class breaks mypyc too. So a class must be created via type ... + rhs = type(\"rhs\", (), {\"__call__\": _rhs})() + if mode.experimental_string_processing: if line.inside_brackets: transformers = [ I also had to change the code accessing __name__ to do so via __class__ so this hack could work. Minor correction though, top-level compiled functions still have __name__, it‚Äôs just nested functions that don‚Äôt have ‚Äôem8. I improved this comment before this landed.\nThe least bad workaround I remember getting an impromptu ‚Äúhow to read mypyc-generated C code‚Äù lesson from @JelleZijlstra 9. I was trying to debug this runtime crash in this black.trans class:\nclass StringParser: \"\"\" [snipped] \"\"\" DEFAULT_TOKEN = -1 # String Parser States START = 1 DOT = 2 NAME = 3 PERCENT = 4 SINGLE_FMT_ARG = 5 LPAR = 6 RPAR = 7 DONE = 8 # Lookup Table for Next State _goto: Dict[Tuple[ParserState, NodeType], ParserState] = { [snipped] } [snipped] Traceback (most recent call last): File \"\", line 1, in \u003cmodule\u003e File \"test2.py\", line 30, in \u003cmodule\u003e (START, DEFAULT_TOKEN): DONE, KeyError: 'DEFAULT_TOKEN It turns out the generated code wanted to access the DEFAULT_TOKEN attribute from the globals dict, predictably blowing up.\ncpy_r_r146 = CPyStatic_globals; cpy_r_r147 = CPyStatics[17]; /* 'DEFAULT_TOKEN' */ cpy_r_r148 = CPyDict_GetItem(cpy_r_r146, cpy_r_r147); If this scares you, don‚Äôt fret, it‚Äôs not impossible to read. First, the globals dict is assigned to cpy_r_r146, then the name (or key) we‚Äôre looking up is read and stored in cpy_r_r147. Finally, cpy_r_r146 and cpy_r_r147 are passed to the CPyDict_GetItem function.\nEffectively, the buggy C code was trying to do this (unnecessary lines were replaced with ...):\nclass StringParser: DEFAULT_TOKEN = -1 START = 1 DONE = 8 ... __var_146 = globals() __var_147 = \"DEFAULT_TOKEN\" __var_148 = var_146[var_147] _goto = { (START, __var_148): DONE ... } The root issue (mypyc#862) is that mypyc doesn‚Äôt understand class level scoping ‚Ä¶ or that negative integers are constants (using a positive integer fixed the crash). I embedded the date I workarounded this issue, I think it‚Äôs a pretty cute historical codebase quirk ‚ùÄ\n@@ -1811,20 +1826,20 @@ class StringParser: ``` \"\"\" - DEFAULT_TOKEN = -1 + DEFAULT_TOKEN: Final = 20210605 Phew, it‚Äôs faster It was at this time I finally posted the first set of benchmark numbers, they weren‚Äôt scientific or reliable in any way, but it did prove mypyc was still a worthwhile way to improve performance. Formatting the Black codebase (so meta, I know) with compiled Black yielded a performance gain of 1.82x, impressive for the short amount of time I had put in!\nI had to verify this experimental build wasn‚Äôt completely unstable though. I couldn‚Äôt just run the test suite with compiled Black installed, some tests use mocks which trigger the strict type checks mypyc does at runtime. Sadly, I had to mark these tests as straight up incompatible so they could be skipped.\nIt‚Äôs still alpha software As of writing mypyc is still alpha software with rough edges everywhere, I already showed quite a few of them above, but there were more üò• You can read the rest in this integration report I filed in the mypyc issue tracker.\nAnd I know, y‚Äôall are wondering why Black didn‚Äôt use Cython, well I‚Äôm not sure as I wasn‚Äôt around in 2019 when @ambv first suggested using mypyc. Eitherway I didn‚Äôt look into Cython because at the time as it seemed like I only had the final scraps left and didn‚Äôt have too much work to do ‚Ä¶ which was both right and wrong depending on how you look at it.\nCould Black be even faster if we had used Cython? Probably, but that would have required learning C which would have taken quite a while.\nAnyway, it‚Äôs time for Pt. 2 - Optimization.\nWhen I first landed the relevant PR it was an overall 2x improvement, but once Jelle added a stability hotfix the effective speedup for files that were changed is 50%. If you‚Äôre formatting a bunch of already well formatted files, the speedup is still 2x¬†‚Ü©Ô∏é\nThere‚Äôs too many typing related PEPs to copy and paste, but there‚Äôs an up to date list here: https://docs.python.org/3/library/typing.html#relevant-peps¬†‚Ü©Ô∏é\nhttps://mypyc.readthedocs.io/en/stable/introduction.html#introduction¬†‚Ü©Ô∏é\nI am well aware I don‚Äôt need to import List or Tuple from typing anymore. I‚Äôm just keeping my code examples compatible with older versions of Python.¬†‚Ü©Ô∏é\nWell not quite exactly this, it was a crappier solution with a time complexity of O(n¬≤) instead of O(n), oh and of course my code style was less than ideal and I didn‚Äôt use type annotations, but let‚Äôs not go there :)¬†‚Ü©Ô∏é\nIt‚Äôs a fork of lib2to3, see https://github.com/psf/black/blob/1e557184b0a9f43bfbff862669966bc5328517e9/src/blib2to3/README for why.¬†‚Ü©Ô∏é\nWhat‚Äôs funny is that the PR which added this __name__ check had a review noting the hackiness of reading the attribute in the first place. It was dismissed as it would have taken too much effort to properly implement the required logic, turns out we got this fun code in return!¬†‚Ü©Ô∏é\nIt‚Äôs because internally mypyc implements nested functions as callable classes¬†‚Ü©Ô∏é\nReading the results searching from:ichard26#4772 in:black-formatter mypyc in the Python Discord server nets some interesting discussion and history :p¬†‚Ü©Ô∏é\n","wordCount":"3108","inLanguage":"en-ca","datePublished":"2022-05-31T16:25:00-04:00","dateModified":"2022-06-04T21:51:00-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-1/"},"publisher":{"@type":"Person","name":"Richard Si","logo":{"@type":"ImageObject","url":"https://ichard26.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ichard26.github.io/ accesskey=h title="Richard Si (Alt + H)">Richard Si</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ichard26.github.io/about/ title=About><span>about</span></a></li><li><a href=https://ichard26.github.io/blog/ title=Writing><span>writing</span></a></li><li><a href=https://ichard26.github.io/privacy/ title="Privacy Statement"><span>privacy</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Compiling Black with mypyc, Pt. 1 - Initial Steps</h1><div class=post-description>I spent a COVID summer (and then some) integrating mypyc into Black to double performance. How was it?</div><div class=post-meta><span class=post-date title='Posted on 2022-05-31 16:25:00 -0400 -0400'>May 31, 2022</span><span class=delimiter>&nbsp;¬∑&nbsp;</span><span class=last-modified title='Updated on 2022-06-04 21:51:00 -0400 -0400'>Updated on June 4, 2022</span><span class=delimiter>&nbsp;¬∑&nbsp;</span>15 minutes</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#introduction-to-mypyc aria-label="Introduction to mypyc">Introduction to mypyc</a><ul><li><a href=#time-for-an-example aria-label="Time for an example">Time for an example</a></li><li><a href=#its-not-a-silver-bullet aria-label="It&rsquo;s not a silver bullet">It&rsquo;s not a silver bullet</a></li></ul></li><li><a href=#black--mypyc-initial-steps aria-label="black + mypyc: Initial steps">black + mypyc: Initial steps</a><ul><li><a href=#more-changes-were-necessary-than-expected aria-label="More changes were necessary than expected">More changes were necessary than expected</a><ul><li><a href=#sad-and-frustrating-changes aria-label="Sad and frustrating changes">Sad and frustrating changes</a></li><li><a href=#hackiness--10000 aria-label="Hackiness += 10000">Hackiness += 10000</a></li><li><a href=#the-least-bad-workaround aria-label="The least bad workaround">The least bad workaround</a></li></ul></li><li><a href=#phew-its-faster aria-label="Phew, it&rsquo;s faster">Phew, it&rsquo;s faster</a></li><li><a href=#its-still-alpha-software aria-label="It&rsquo;s still alpha software">It&rsquo;s still alpha software</a></li></ul></li></ul></div></details></div><div class=post-content><p><a href=https://github.com/psf/black/releases/tag/22.1.0 target=_blank>Release 22.1.0 of Black</a> was special, not only was it the first stable
version of Black, it was also the first release to ship with <a href=https://mypyc.readthedocs.io/en/stable/introduction.html target=_blank>mypyc</a> compiled wheels,
doubling performance<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> üéâ.</p><p>The journey getting here took over two years, the creation of two new dev tools, and lots
and lots of headscratching. Let&rsquo;s go down memory lane, shall we?</p><hr><p>This is a long story so it&rsquo;s broken up into three parts. Collectively this is the
<em>Compiling Black with mypyc</em> series.</p><ul><li><a href=.>Pt. 1 - Initial Steps</a> (you&rsquo;re reading this one)</li><li><a href=../compiling-black-with-mypyc-part-2/>Pt. 2 - Optimization</a></li><li><a href=../compiling-black-with-mypyc-part-3/>Pt. 3 - Deployment</a></li></ul><blockquote><p>While I&rsquo;d love it if you would read this end to end, I totally understand if this ends
up in the &ldquo;to read later&rdquo; section of your bookmarks. I just hope you enjoy whatever you
do read!</p></blockquote><p>&mldr; and yes it took me almost 6 months after deploying mypyc to write this.</p><h2 id=introduction-to-mypyc>Introduction to mypyc<a hidden class=anchor aria-hidden=true href=#introduction-to-mypyc>#</a></h2><p>Before I dig into the story of how I integrated mypyc into Black, I want to explain what
mypyc is and show an example using it. <strong>mypyc is a <a href=https://en.wikipedia.org/wiki/Source-to-source_compiler target=_blank>transcompiler</a> converting typed
Python code into fast C extensions.</strong> Being built on top of the <a href=https://mypy.readthedocs.io/en/stable/ target=_blank>mypy</a> type checker, it
leverages standard type annotations<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> (unlike Cython).</p><p>It has been used to compile mypy (and itself since mypyc comes with mypy) since 2019,
giving it a 4x performance boost over interpreted Python. According to the mypyc project:</p><blockquote><p>Existing code with type annotations is often 1.5x to 5x faster when compiled. Code tuned
for mypyc can be 5x to 10x faster.<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p></blockquote><p>It achieves these impressive speed ups by:</p><ul><li><p>Using the C-API directly, avoiding the CPython interpreter overhead.</p></li><li><p>Leveraging <em>early binding</em>, resolving called functions and names at compile-time,
skipping the expensive dictionary lookup at runtime.</p></li><li><p>Using optimized, type-specific primitives for many built-in functions and methods.</p></li><li><p>Using custom memory-efficient, unboxed representations for integers and booleans.</p></li><li><p>Compiling regular classes to C extension classes. C extension classes use <a href=https://en.wikipedia.org/wiki/Virtual_method_table target=_blank>vtables</a> for
fast method calls and attribute access.</p></li></ul><p>&mldr; and other optimizations I&rsquo;ve left out for the sake of brevity.</p><hr><h3 id=time-for-an-example>Time for an example<a hidden class=anchor aria-hidden=true href=#time-for-an-example>#</a></h3><p>Interested? I sure hope so since it&rsquo;s time for an example! To get started, create a
throwaway directory somewhere, a virtual environment, and install mypy. As of writing I&rsquo;m
using mypy 0.931 on Ubuntu 20.04.03 with CPython 3.8.5.</p><p>Next, let&rsquo;s take a look at the code<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> we&rsquo;ll soon compile. It&rsquo;s a simple program that
bruteforces its way to find all of the factor pairs for a given product. I mostly chose
this example because it&rsquo;s very dear to my heart. It was the first &ldquo;serious&rdquo; program I
wrote while learning Python<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>. I originally wrote the same logic in code.org&rsquo;s app lab
many years ago.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> List, Tuple
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>compute</span>(product: int) <span style=color:#f92672>-&gt;</span> List[Tuple[int, int]]:
</span></span><span style=display:flex><span>    answers <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> factor <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, product <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> product <span style=color:#f92672>%</span> factor:
</span></span><span style=display:flex><span>            factor2 <span style=color:#f92672>=</span> int(product <span style=color:#f92672>/</span> factor)
</span></span><span style=display:flex><span>            answers<span style=color:#f92672>.</span>append((factor, factor2))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> answers
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>t0 <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>perf_counter()
</span></span><span style=display:flex><span>compute(<span style=color:#ae81ff>27_000_000</span>)
</span></span><span style=display:flex><span>elapsed <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>perf_counter() <span style=color:#f92672>-</span> t0
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;compute() took </span><span style=color:#e6db74>{</span>elapsed <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span><span style=color:#e6db74>:</span><span style=color:#e6db74>.1f</span><span style=color:#e6db74>}</span><span style=color:#e6db74> milliseconds&#34;</span>)
</span></span></code></pre></div><p>Once saved, run it noting the time it takes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ python coefficient_finder.py
</span></span><span style=display:flex><span>compute() took 1880.7 milliseconds
</span></span></code></pre></div><p>Alright, it&rsquo;s a bit slow, let&rsquo;s see if mypyc can change that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ mypyc coefficient_finder.py
</span></span><span style=display:flex><span>running build_ext
</span></span><span style=display:flex><span>creating build/temp.linux-x86_64-3.8
</span></span><span style=display:flex><span>creating build/temp.linux-x86_64-3.8/build
</span></span><span style=display:flex><span>gcc -pthread -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/ichard26/programming/webdev/blog/testing-grounds/venv/lib/python3.8/site-packages/mypyc/lib-rt -I/home/ichard26/programming/webdev/blog/testing-grounds/venv/include -I/opt/python3.8.5/include/python3.8 -c build/__native.c -o build/temp.linux-x86_64-3.8/build/__native.o -O3 -g1 -Werror -Wno-unused-function -Wno-unused-label -Wno-unreachable-code -Wno-unused-variable -Wno-unused-command-line-argument -Wno-unknown-warning-option -Wno-unused-but-set-variable
</span></span><span style=display:flex><span>creating build/lib.linux-x86_64-3.8
</span></span><span style=display:flex><span>gcc -pthread -shared build/temp.linux-x86_64-3.8/build/__native.o -o build/lib.linux-x86_64-3.8/coefficient_finder.cpython-38-x86_64-linux-gnu.so
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>$ python -c <span style=color:#e6db74>&#34;import coefficient_finder&#34;</span>
</span></span><span style=display:flex><span>compute() took 331.6 milliseconds
</span></span></code></pre></div><p>And would you look at that, mypyc gave us a near 6x improvement over CPython! What&rsquo;s neat
is that <strong>I didn&rsquo;t even need to type all of the variables thanks to mypy&rsquo;s type
inference</strong>.</p><blockquote><p>And actually, since the <code>mypyc</code> script is a simple wrapper that generates a setuptools
project and builds it in-place, you can peek into the <code>build</code> directory and look at the
generated C code (should be in <code>__native.c</code>).</p></blockquote><p>Feel free to edit the program and play around with mypyc, seeing what little scripts it
can speed up. Pro-tip, to restore back to the interpreted version of your program, you can
delete the <code>.so</code> file on Linux & MacOS or the <code>.pyd</code> file on Windows. In this example I
got <code>coefficient_finder.cpython-38-x86_64-linux-gnu.so</code>.</p><hr><h3 id=its-not-a-silver-bullet>It&rsquo;s not a silver bullet<a hidden class=anchor aria-hidden=true href=#its-not-a-silver-bullet>#</a></h3><p>There&rsquo;s several downsides to using mypyc. While the project aims for excellent
compatibility with CPython, there are some major deviations worth noting:</p><ul><li><p>Types are enforced at runtime and violations <strong>will</strong> cause a TypeError (this makes
using <code>typing.Any</code> quite dangerous).</p></li><li><p>Compiled modules can&rsquo;t be run directly, you have to import &rsquo;em instead.</p></li><li><p>Monkeypatching anything compiled is unlikely to work as compiled code skips many of the
runtime <code>__dict__</code> lookups normal Python does.</p></li><li><p>Assignments to class and instance namespaces will either error or do nothing, in
particular you can&rsquo;t add previously undeclared attributes later on.</p></li><li><p>Standard multiple inheritance isn&rsquo;t supported.</p></li><li><p>Profilers (e.g. CProfile), debuggers (e.g. pdb), and tracing hooks (e.g. coverage) won&rsquo;t
work as the C code doesn&rsquo;t trigger the relevant hooks.</p></li></ul><p>There are more details available in the official
<a href=https://mypyc.readthedocs.io/en/stable/differences_from_python.html target=_blank>mypyc documentation here</a> and <a href=https://mypyc.readthedocs.io/en/stable/native_classes.html target=_blank>also here</a>.</p><h2 id=black--mypyc-initial-steps>black + mypyc: Initial steps<a hidden class=anchor aria-hidden=true href=#black--mypyc-initial-steps>#</a></h2><p>I wasn&rsquo;t the first person to integrate mypyc into Black; way back in September 2019,
<a href=https://github.com/msullivan target=_blank>@msullivan</a> <a href=https://github.com/psf/black/pull/1009 target=_blank>opened a PR getting Black ready</a> for compilation.
Unfortunately, as is typical in open source projects, no one took the half-completed work
and pushed it to completion &mldr; for almost two years.</p><blockquote><p>You might be wondering why performance even matters, well clearly it mattered a lot
since <a href=https://github.com/psf/black/issues/366 target=_blank>GH-366</a> was opened in June 2018! The TL;DR is that for environments where Black
is <strong>ran on save automatically, the more responsive it is the better</strong> as less time is
spent in a laggy editor window.</p><p>Start up time is important too given imports are costly (it turns out mypyc can reduce
import time too!), but this issue was explicitly about formatting throughput.</p></blockquote><p>Given I first publicly announced my work finishing up the project on July 4th 2021, I
sadly don&rsquo;t remember why I decided to pick it up. All I remember was fighting mypyc
compile-time type errors and fighting an outdated gcc&mldr; well OK I do remember I was
looking to learn more about type systems and C development in general, but that&rsquo;s it, I
promise!</p><p>First off, as of writing mypyc has a bug (<a href=https://github.com/mypyc/mypyc/issues/885 target=_blank>mypyc#885</a>) where its boxing & unboxing code
triggers <code>array subscript 1 is above array bounds</code> on
<a href=https://github.com/psf/black/blob/8ea641eed5b9540287a8e9a9afa1458b72b9b630/src/blib2to3/pgen2/parse.py#L117-L139 target=_blank><code>blib2to3.pgen2.parse.Parser.setup</code></a>. I simplified the reproduction case to
the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Optional, Tuple
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Context <span style=color:#f92672>=</span> Tuple[str, Tuple[int, int]]
</span></span><span style=display:flex><span>RawNode <span style=color:#f92672>=</span> Tuple[int, Optional[str], Optional[Context]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>setup</span>() <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># This is what ticks off gcc.</span>
</span></span><span style=display:flex><span>    newnode: RawNode <span style=color:#f92672>=</span> (<span style=color:#ae81ff>7</span>, <span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>)
</span></span></code></pre></div><p>&mldr; yeah, I know this makes mypyc look fragile. While it&rsquo;s not entirely stupid to use it
in production (because I did so), you&rsquo;d be right in pointing out it&rsquo;s alpha quality and
needs careful testing. And to be fair, poor past me didn&rsquo;t know just how many issues I&rsquo;d
soon face. All I can hope is that this work will help mypyc improve ‚ùÄ</p><p>Anyway I switched to clang and this issue disappeared &mldr;</p><p>Trying to compile <code>black</code> and <code>blib2to3</code><sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup> initially seemed like a small task with just
these type errors:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ python setup.py --use-mypyc bdist_wheel
</span></span><span style=display:flex><span>Parsed and typechecked in 8.566s
</span></span><span style=display:flex><span>Compiled to C in 0.000s
</span></span><span style=display:flex><span>src/black/parsing.py:30:9: error: Cannot assign multiple modules to name &#34;ast3&#34; without explicit &#34;types.ModuleType&#34; annotation
</span></span><span style=display:flex><span>src/black/parsing.py:30:9: error: Cannot assign multiple modules to name &#34;ast27&#34; without explicit &#34;types.ModuleType&#34; annotation
</span></span><span style=display:flex><span>src/black/parsing.py:146:13: error: Incompatible types in assignment (expression has type &#34;Tuple[Type[typed_ast.ast3.TypeIgnore], Type[typed_ast.ast27.TypeIgnore], Type[_ast.TypeIgnore]]&#34;, variable has type &#34;Tuple[Type[typed_ast.ast3.TypeIgnore], Type[typed_ast.ast27.TypeIgnore]]&#34;)
</span></span></code></pre></div><p>The ones about <code>Cannot assign multiple modules to name ...</code> are valid if annoying, back
then the code in <code>black.parsing</code> was pretty dynamic. The other one was just that mypy
under &ldquo;mypyc super-strict mode&rdquo; won&rsquo;t infer a variable to be a variable-length tuple even
if it&rsquo;s extended right after:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>stringify_ast</span>(
</span></span><span style=display:flex><span>    node: Union[ast<span style=color:#f92672>.</span>AST, ast3<span style=color:#f92672>.</span>AST, ast27<span style=color:#f92672>.</span>AST], depth: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>) <span style=color:#f92672>-&gt;</span> Iterator[str]:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Simple visitor generating strings to compare ASTs by content.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    node <span style=color:#f92672>=</span> fixup_ast_constants(node)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>yield</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span><span style=color:#e6db74>&#39;  &#39;</span> <span style=color:#f92672>*</span> depth<span style=color:#e6db74>}{</span>node<span style=color:#f92672>.</span>__class__<span style=color:#f92672>.</span>__name__<span style=color:#e6db74>}</span><span style=color:#e6db74>(&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> field <span style=color:#f92672>in</span> sorted(node<span style=color:#f92672>.</span>_fields):  <span style=color:#75715e># noqa: F402</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># TypeIgnore has only one field &#39;lineno&#39; which breaks this comparison</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        type_ignore_classes <span style=color:#f92672>=</span> (ast3<span style=color:#f92672>.</span>TypeIgnore, ast27<span style=color:#f92672>.</span>TypeIgnore)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> sys<span style=color:#f92672>.</span>version_info <span style=color:#f92672>&gt;=</span> (<span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>8</span>):
</span></span><span style=display:flex><span>            type_ignore_classes <span style=color:#f92672>+=</span> (ast<span style=color:#f92672>.</span>TypeIgnore,)
</span></span></code></pre></div><p>The fix was to add <code>Tuple[Type, ...]</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span>type_ignore_classes: Tuple[Type, <span style=color:#f92672>...</span>] <span style=color:#f92672>=</span> (ast3<span style=color:#f92672>.</span>TypeIgnore, ast27<span style=color:#f92672>.</span>TypeIgnore)
</span></span></code></pre></div><p>Now, the codebase was able to type check even under &ldquo;mypyc super-strict mode,&rdquo; but
<em>obviously</em> that just meant I had another class of fires to deal with, *compiler
crashes*!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ python setup.py --use-mypyc bdist_wheel
</span></span><span style=display:flex><span>Parsed and typechecked in 8.929s
</span></span><span style=display:flex><span>Compiling cache, strings, black, debug, parsing, brackets, lines, files, literals, conv, trans, linegen, numerics, nodes, const, pgen, pygram, output, token, concurrency, parse, report, mode, driver, grammar, tokenize, pytree, rusty, comments
</span></span><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span>  File &#34;mypyc/irbuild/builder.py&#34;, line 169, in accept
</span></span><span style=display:flex><span>  File &#34;mypy/nodes.py&#34;, line 950, in accept
</span></span><span style=display:flex><span>  File &#34;mypyc/irbuild/visitor.py&#34;, line 104, in visit_class_def
</span></span><span style=display:flex><span>  File &#34;mypyc/irbuild/classdef.py&#34;, line 137, in transform_class_def
</span></span><span style=display:flex><span>  File &#34;mypyc/irbuild/classdef.py&#34;, line 388, in generate_attr_defaults
</span></span><span style=display:flex><span>  File &#34;mypyc/ir/class_ir.py&#34;, line 174, in attr_type
</span></span><span style=display:flex><span>  File &#34;mypyc/ir/class_ir.py&#34;, line 171, in attr_details
</span></span><span style=display:flex><span>src/black/trans.py:187: KeyError: &#34;&#39;CustomSplitMapMixin&#39; has no attribute &#39;_Key&#39;&#34;
</span></span></code></pre></div><p>This issue was just due to missing <code>ClassVar</code> declarations for attributes that are
functionally class-only attributes. The fix was pretty easy :)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a6e22e>+@trait
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> class CustomSplitMapMixin:
</span></span><span style=display:flex><span>     &#34;&#34;&#34;
</span></span><span style=display:flex><span>     This mixin class is used to map merged strings to a sequence of
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -191,8 +204,10 @@ class CustomSplitMapMixin:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     the resultant substrings go over the configured max line length.
</span></span><span style=display:flex><span>     &#34;&#34;&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-    _Key = Tuple[StringID, str]
</span></span></span><span style=display:flex><span><span style=color:#f92672>-    _CUSTOM_SPLIT_MAP: Dict[_Key, Tuple[CustomSplit, ...]] = defaultdict(tuple)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    _Key: ClassVar = Tuple[StringID, str]
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    _CUSTOM_SPLIT_MAP: ClassVar[Dict[_Key, Tuple[CustomSplit, ...]]] = defaultdict(
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        tuple
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    )
</span></span></span></code></pre></div><p>Do you see that <code>@trait</code> addition? well &mldr; mypyc does in fact <strong>support a limited form of
multiple inheritance called <em>traits</em></strong>. They&rsquo;re basically mixins. As noted in the
<a href=https://mypyc.readthedocs.io/en/latest/using_type_annotations.html#trait-types target=_blank>mypyc documentation</a>, they shouldn&rsquo;t be instantiated or subclass non-traits.</p><p>And as usual, fixing this crash revealed *even* *more* *issues*, albeit mypyc
specific this time:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ python setup.py --use-mypyc bdist_wheel
</span></span><span style=display:flex><span>Parsed and typechecked in 8.122s
</span></span><span style=display:flex><span>Compiling pgen, parse, parsing, mode, pytree, token, debug, const, lines, numerics, rusty, conv, comments, files, trans, cache, black, grammar, output, brackets, tokenize, linegen, pygram, report, literals, nodes, strings, concurrency, driver
</span></span><span style=display:flex><span>Compiled to C in 0.970s
</span></span><span style=display:flex><span>src/black/trans.py:250: error: Non-trait bases must appear first in parent list
</span></span><span style=display:flex><span>src/black/trans.py:934: error: Non-trait bases must appear first in parent list
</span></span><span style=display:flex><span>src/black/trans.py:1433: error: Non-trait bases must appear first in parent list
</span></span><span style=display:flex><span>src/black/brackets.py:52: error: Inheriting from most builtin types is unimplemented
</span></span><span style=display:flex><span>src/black/files.py:52: warning: Treating generator comprehension as list
</span></span><span style=display:flex><span>src/black/trans.py:746: warning: Unsupported default attribute value
</span></span><span style=display:flex><span>src/black/trans.py:1831: warning: Unsupported default attribute value
</span></span><span style=display:flex><span>src/blib2to3/pgen2/tokenize.py:430: error: Local variable &#34;stashed&#34; has inferred type None; add an annotation
</span></span><span style=display:flex><span>src/black/nodes.py:442: error: Local variable &#34;stop_after&#34; has inferred type None; add an annotation
</span></span><span style=display:flex><span>src/black/nodes.py:443: error: Local variable &#34;last&#34; has inferred type None; add an annotation
</span></span></code></pre></div><p>These were pretty straightforward to fix and sometimes even improved code clarity, forcing
me to add type annotations in complex code.</p><h3 id=more-changes-were-necessary-than-expected>More changes were necessary than expected<a hidden class=anchor aria-hidden=true href=#more-changes-were-necessary-than-expected>#</a></h3><p>All of this was only to get the codebase to type check and not crash the compiler. Getting
the built binary to not crash at runtime needed more work. Some of these changes were
improvements, like this one which involved an incorrect type annotation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/src/black/__init__.py b/src/black/__init__.py
</span></span><span style=display:flex><span>index 8e2123d..6998c1e 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/black/__init__.py
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/black/__init__.py
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -359,7 +359,7 @@ def main(
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     experimental_string_processing: bool,
</span></span><span style=display:flex><span>     quiet: bool,
</span></span><span style=display:flex><span>     verbose: bool,
</span></span><span style=display:flex><span><span style=color:#f92672>-    required_version: str,
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    required_version: Optional[str],
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>     include: Pattern,
</span></span><span style=display:flex><span>     exclude: Optional[Pattern],
</span></span><span style=display:flex><span>     extend_exclude: Optional[Pattern],
</span></span></code></pre></div><blockquote><p>This goes to show that while the strict runtime type checks can be very annoying, they
do have value beyond memory safety.</p></blockquote><h4 id=sad-and-frustrating-changes>Sad and frustrating changes<a hidden class=anchor aria-hidden=true href=#sad-and-frustrating-changes>#</a></h4><p>&mldr; but others were just sad or annoying (mixing dataclasses with anything remotely fancy
breaks mypyc).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/src/black/linegen.py b/src/black/linegen.py
</span></span><span style=display:flex><span>index 76b553a..1691cc5 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/black/linegen.py
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/black/linegen.py
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -40,7 +38,8 @@ class CannotSplit(CannotTransform):
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     &#34;&#34;&#34;A readable split that fits the allotted line length is impossible.&#34;&#34;&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-@dataclass
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+# This isn&#39;t a dataclass because @dataclass + Generic breaks mypyc.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+# See also https://github.com/mypyc/mypyc/issues/827.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> class LineGenerator(Visitor[Line]):
</span></span><span style=display:flex><span>     &#34;&#34;&#34;Generates reformatted Line objects.  Empty lines are not emitted.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -48,9 +47,11 @@ class LineGenerator(Visitor[Line]):
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     in ways that will no longer stringify to valid Python code on the tree.
</span></span><span style=display:flex><span>     &#34;&#34;&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-    mode: Mode
</span></span></span><span style=display:flex><span><span style=color:#f92672>-    remove_u_prefix: bool = False
</span></span></span><span style=display:flex><span><span style=color:#f92672>-    current_line: Line = field(init=False)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    def __init__(self, mode: Mode, remove_u_prefix: bool = False) -&gt; None:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        self.mode = mode
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        self.remove_u_prefix = remove_u_prefix
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        self.current_line: Line
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        self.__post_init__()
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>     def line(self, indent: int = 0) -&gt; Iterator[Line]:
</span></span><span style=display:flex><span>         &#34;&#34;&#34;Generate a line.
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/src/black/trans.py b/src/black/trans.py
</span></span><span style=display:flex><span>index 023dcd3..d918ef1 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/black/trans.py
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/black/trans.py
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -62,7 +71,6 @@ def TErr(err_msg: str) -&gt; Err[CannotTransform]:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     return Err(cant_transform)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-@dataclass  # type: ignore
</span></span></span><span style=display:flex><span><span style=color:#f92672></span> class StringTransformer(ABC):
</span></span><span style=display:flex><span>     &#34;&#34;&#34;
</span></span><span style=display:flex><span>     An implementation of the Transformer protocol that relies on its
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -90,9 +98,13 @@ class StringTransformer(ABC):
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         as much as possible.
</span></span><span style=display:flex><span>     &#34;&#34;&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-    line_length: int
</span></span></span><span style=display:flex><span><span style=color:#f92672>-    normalize_strings: bool
</span></span></span><span style=display:flex><span><span style=color:#f92672>-    __name__ = &#34;StringTransformer&#34;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    __name__: Final = &#34;StringTransformer&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    # Ideally this would be a dataclass, but unfortunately mypyc breaks when used with
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    # `abc.ABC`.
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+    def __init__(self, line_length: int, normalize_strings: bool) -&gt; None:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        self.line_length = line_length
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        self.normalize_strings = normalize_strings
</span></span></span></code></pre></div><h4 id=hackiness--10000>Hackiness += 10000<a hidden class=anchor aria-hidden=true href=#hackiness--10000>#</a></h4><p>One change stood out as the most hacky<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup> code I&rsquo;ve probably ever written so far:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/src/black/linegen.py b/src/black/linegen.py
</span></span><span style=display:flex><span>index 76b553a..1691cc5 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/black/linegen.py
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/black/linegen.py
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -335,7 +336,9 @@ def transform_line(
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         transformers = [left_hand_split]
</span></span><span style=display:flex><span>     else:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-        def rhs(line: Line, features: Collection[Feature]) -&gt; Iterator[Line]:
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+        def _rhs(
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+            self: object, line: Line, features: Collection[Feature]
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        ) -&gt; Iterator[Line]:
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>             &#34;&#34;&#34;Wraps calls to `right_hand_split`.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             The calls increasingly `omit` right-hand trailers (bracket pairs with
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -362,6 +365,11 @@ def transform_line(
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                 line, line_length=mode.line_length, features=features
</span></span><span style=display:flex><span>             )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+        # HACK: functions (like rhs) compiled by mypyc don&#39;t retain their __name__
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        # attribute which is needed in `run_transformer` further down. Unfortunately
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        # a nested class breaks mypyc too. So a class must be created via type ...
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+        rhs = type(&#34;rhs&#34;, (), {&#34;__call__&#34;: _rhs})()
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>         if mode.experimental_string_processing:
</span></span><span style=display:flex><span>             if line.inside_brackets:
</span></span><span style=display:flex><span>                 transformers = [
</span></span></code></pre></div><p>I also had to change the code accessing <code>__name__</code> to do so via <code>__class__</code> so this hack
could work. Minor correction though, top-level compiled functions still have <code>__name__</code>,
it&rsquo;s just nested functions that don&rsquo;t have &rsquo;em<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>. I improved this comment before this
landed.</p><h4 id=the-least-bad-workaround>The least bad workaround<a hidden class=anchor aria-hidden=true href=#the-least-bad-workaround>#</a></h4><p>I remember getting an impromptu &ldquo;how to read mypyc-generated C code&rdquo; lesson from
<a href=https://github.com/JelleZijlstra target=_blank>@JelleZijlstra</a> <sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>. I was trying to debug this runtime crash in this <code>black.trans</code>
class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python3 data-lang=python3><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StringParser</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    [snipped]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    DEFAULT_TOKEN <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># String Parser States</span>
</span></span><span style=display:flex><span>    START <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    DOT <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    NAME <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    PERCENT <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>    SINGLE_FMT_ARG <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>    LPAR <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>    RPAR <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>    DONE <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Lookup Table for Next State</span>
</span></span><span style=display:flex><span>    _goto: Dict[Tuple[ParserState, NodeType], ParserState] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        [snipped]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [snipped]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;&lt;stdin&gt;&#34;</span>, line <span style=color:#ae81ff>1</span>, <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;test2.py&#34;</span>, line <span style=color:#ae81ff>30</span>, <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>    (START, DEFAULT_TOKEN): DONE,
</span></span><span style=display:flex><span><span style=color:#a6e22e>KeyError</span>: <span style=color:#e6db74>&#39;DEFAULT_TOKEN</span>
</span></span></code></pre></div><p>It turns out the generated code wanted to access the <code>DEFAULT_TOKEN</code> attribute from the
globals dict, predictably blowing up.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-c data-lang=c><span style=display:flex;background-color:#3c3d38><span>    cpy_r_r146 <span style=color:#f92672>=</span> CPyStatic_globals;
</span></span><span style=display:flex><span>    cpy_r_r147 <span style=color:#f92672>=</span> CPyStatics[<span style=color:#ae81ff>17</span>]; <span style=color:#75715e>/* &#39;DEFAULT_TOKEN&#39; */</span>
</span></span><span style=display:flex><span>    cpy_r_r148 <span style=color:#f92672>=</span> <span style=color:#a6e22e>CPyDict_GetItem</span>(cpy_r_r146, cpy_r_r147);
</span></span></code></pre></div><p>If this scares you, don&rsquo;t fret, it&rsquo;s not impossible to read. First, the globals dict is
assigned to <code>cpy_r_r146</code>, then the name (or key) we&rsquo;re looking up is read and stored in
<code>cpy_r_r147</code>. Finally, <code>cpy_r_r146</code> and <code>cpy_r_r147</code> are passed to the <code>CPyDict_GetItem</code>
function.</p><p>Effectively, the buggy C code was trying to do this (unnecessary lines were replaced with
<code>...</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StringParser</span>:
</span></span><span style=display:flex><span>    DEFAULT_TOKEN <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    START <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    DONE <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    __var_146 <span style=color:#f92672>=</span> globals()
</span></span><span style=display:flex><span>    __var_147 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DEFAULT_TOKEN&#34;</span>
</span></span><span style=display:flex><span>    __var_148 <span style=color:#f92672>=</span> var_146[var_147]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    _goto <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        (START, __var_148): DONE
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>The root issue (<a href=https://github.com/mypyc/mypyc/issues/862 target=_blank>mypyc#862</a>) is that mypyc doesn&rsquo;t understand class level scoping &mldr; or
that negative integers are constants (using a positive integer fixed the crash). I
embedded the date I workarounded this issue, I think it&rsquo;s a pretty cute historical
codebase quirk ‚ùÄ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#75715e>@@ -1811,20 +1826,20 @@ class StringParser:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         ```
</span></span><span style=display:flex><span>     &#34;&#34;&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-    DEFAULT_TOKEN = -1
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+    DEFAULT_TOKEN: Final = 20210605
</span></span></span></code></pre></div><hr><h3 id=phew-its-faster><em>Phew</em>, it&rsquo;s faster<a hidden class=anchor aria-hidden=true href=#phew-its-faster>#</a></h3><p>It was at this time I finally posted the
<a href=https://github.com/psf/black/issues/366#issuecomment-855306152 target=_blank>first set of benchmark numbers</a>, they weren&rsquo;t scientific or reliable in
any way, but it did prove mypyc was still a worthwhile way to improve performance.
Formatting the Black codebase (so meta, I know) with compiled Black yielded a performance
gain of 1.82x, impressive for the short amount of time I had put in!</p><p>I had to verify this experimental build wasn&rsquo;t completely unstable though. I couldn&rsquo;t just
run the test suite with compiled Black installed, some tests use mocks which trigger the
strict type checks mypyc does at runtime. Sadly, I had to mark these tests as straight up
incompatible so they could be skipped.</p><h3 id=its-still-alpha-software>It&rsquo;s still alpha software<a hidden class=anchor aria-hidden=true href=#its-still-alpha-software>#</a></h3><p>As of writing mypyc is still alpha software with rough edges everywhere, I already showed
quite a few of them above, but there were more üò• You can read the rest in this
<a href=https://github.com/mypyc/mypyc/issues/886 target=_blank>integration report</a> I filed in the mypyc issue tracker.</p><p>And I know, y&rsquo;all are wondering why Black didn&rsquo;t use Cython, well I&rsquo;m not sure as I wasn&rsquo;t
around in 2019 when <a href=https://github.com/psf/black/issues/366#issuecomment-490153026 target=_blank>@ambv first suggested using mypyc</a>. Eitherway
I didn&rsquo;t look into Cython because at the time as it seemed like I only had the final
scraps left and didn&rsquo;t have too much work to do &mldr; which was both right and wrong
depending on how you look at it.</p><p>Could Black be even faster if we had used Cython? Probably, but that would have required
learning C which would have taken quite a while.</p><p><strong>Anyway, it&rsquo;s time for <a href=../compiling-black-with-mypyc-part-2/>Pt. 2 - Optimization</a>.</strong></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>When I first landed the relevant PR it was an overall 2x improvement, but once Jelle
added a stability hotfix the <em>effective</em> speedup for files that were changed is 50%.
If you&rsquo;re formatting a bunch of already well formatted files, the speedup is still 2x&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>There&rsquo;s too many typing related PEPs to copy and paste, but there&rsquo;s an up to date list
here: <a href=https://docs.python.org/3/library/typing.html#relevant-peps target=_blank>https://docs.python.org/3/library/typing.html#relevant-peps</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://mypyc.readthedocs.io/en/stable/introduction.html#introduction target=_blank>https://mypyc.readthedocs.io/en/stable/introduction.html#introduction</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>I am well aware I don&rsquo;t need to import <code>List</code> or <code>Tuple</code> from <code>typing</code> anymore. I&rsquo;m
just keeping my code examples compatible with older versions of Python.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>Well not quite exactly this, it was a crappier solution with a time complexity of
O(n¬≤) instead of O(n), oh and of course my code style was less than ideal and I didn&rsquo;t
use type annotations, but let&rsquo;s not go there :)&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>It&rsquo;s a fork of lib2to3, see
<a href=https://github.com/psf/black/blob/1e557184b0a9f43bfbff862669966bc5328517e9/src/blib2to3/README target=_blank>https://github.com/psf/black/blob/1e557184b0a9f43bfbff862669966bc5328517e9/src/blib2to3/README</a>
for why.&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p>What&rsquo;s funny is that the PR which added this <code>__name__</code> check had a review noting the
hackiness of reading the attribute in the first place. It was dismissed as it would
have taken too much effort to properly implement the required logic, turns out we got
this fun code in return!&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p>It&rsquo;s because internally mypyc implements nested functions as callable classes&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9><p>Reading the results searching <code>from:ichard26#4772 in:black-formatter mypyc</code> in the
Python Discord server nets some interesting discussion and history :p&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://ichard26.github.io/tags/black/>Black</a></li><li><a href=https://ichard26.github.io/tags/mypyc/>Mypyc</a></li></ul><nav class=paginav><a class=prev href=https://ichard26.github.io/blog/2022/05/compiling-black-with-mypyc-part-2/><span class=title>¬´ Newer</span><br><span>Compiling Black with mypyc, Pt. 2 - Optimization</span></a></nav></footer></article></main><footer class=footer><span>¬© 2022-present, Richard Si</span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>